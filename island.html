<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <title>Study Land - æˆ‘çš„å³¶å¶¼</title>
  <style>
    :root { --primary: #4db6ac; }
    
    body { 
      font-family: 'Microsoft JhengHei', sans-serif; 
      margin: 0; 
      overflow: hidden; 
      /* è¨­å®š GitHub ä¸Šçš„ Sky.png ç‚ºå…¨ç¶²é èƒŒæ™¯ */
      background-image: url('https://raw.githubusercontent.com/linda0322/StudyLand/refs/heads/main/image/Sky.png');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      background-color: #add8e6; 
    }
    
    /* å¤§å»³æ¨£å¼ - ä½¿ç”¨ç£¨ç ‚ç»ç’ƒæ•ˆæœ */
    #lobby { 
      padding: 20px; 
      text-align: center; 
      height: 100vh; 
      overflow-y: auto;
      background: rgba(255, 255, 255, 0.2); 
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }

    .island-grid { 
      display: flex; 
      flex-wrap: wrap; 
      gap: 30px; 
      justify-content: center; 
      padding: 40px 20px; 
    }
    
    .island-card { 
      width: 240px; 
      height: 180px; 
      background: white; 
      border-radius: 20px; 
      cursor: pointer; 
      position: relative; 
      border: 5px solid white; 
      box-shadow: 0 10px 20px rgba(0,0,0,0.2);
      background-size: cover; 
      background-position: center;
      transition: transform 0.3s, box-shadow 0.3s;
    }
    .island-card:hover { 
      transform: translateY(-10px) scale(1.02); 
      box-shadow: 0 15px 30px rgba(0,0,0,0.3);
    }
    .island-card div { 
      position: absolute; 
      bottom: 0; 
      width: 100%; 
      background: rgba(0,0,0,0.65); 
      color: white; 
      font-size: 16px; 
      font-weight: bold;
      padding: 10px 0; 
      border-bottom-left-radius: 15px; 
      border-bottom-right-radius: 15px; 
    }

    /* å³¶å¶¼å…§éƒ¨è¦–åœ– */
    #islandView { 
      display: none; 
      width: 100vw; 
      height: 100vh; 
      position: relative; 
      background-size: cover; 
      background-position: center; 
    }
    
    .asset { 
      position: absolute; 
      cursor: move; 
      width: 90px; 
      transition: transform 0.1s; 
      user-select: none; 
      touch-action: none; 
      filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.3));
    }
    .asset:active { 
      transform: scale(1.15); 
      z-index: 9999; 
    }
    
    /* å·¥å…·åˆ— */
    .toolbar { 
      position: fixed; 
      top: 20px; 
      left: 20px; 
      z-index: 1000; 
      display: flex; 
      gap: 15px; 
    }
    .btn { 
      padding: 12px 25px; 
      border-radius: 30px; 
      border: none; 
      cursor: pointer; 
      font-weight: bold; 
      font-size: 14px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      transition: background 0.2s;
    }
    .btn-save { background: #ff9800; color: white; }
    .btn-save:hover { background: #f57c00; }
    .btn-back { background: #607d8b; color: white; }
    .btn-back:hover { background: #455a64; }

    /* è¼‰å…¥ä¸­å‹•ç•« */
    #loadingOverlay {
      position: fixed; top:0; left:0; width:100%; height:100%;
      background: rgba(0,0,0,0.5); color:white;
      display:none; flex-direction:column; justify-content:center; align-items:center;
      z-index: 2000;
    }
  </style>
</head>
<body>

  <div id="loadingOverlay">
    <div style="font-size: 20px; margin-bottom:10px;">â˜ï¸ æ­£åœ¨èˆ‡é›²ç«¯åŒæ­¥...</div>
  </div>

  <div id="lobby">
    <h1 style="color: #004d40; text-shadow: 2px 2px 4px rgba(255,255,255,0.8); font-size: 32px; margin-top: 40px;">ğŸï¸ æˆ‘çš„å³¶å¶¼ä¸–ç•Œ</h1>
    <div id="islandContainer" class="island-grid">æ­£åœ¨é–‹å•Ÿé›²ç«¯åœ°åœ–...</div>
  </div>

  <div id="islandView">
    <div class="toolbar">
      <button class="btn btn-back" onclick="backToLobby()">â¬… è¿”å›å¤§å»³</button>
      <button class="btn btn-save" onclick="savePositions()">ğŸ’¾ å„²å­˜ä½ˆç½®</button>
    </div>
    <div id="assetLayer"></div>
  </div>

  <script>
    /**
     * è‡ªå‹•è­˜åˆ¥ä½¿ç”¨è€…åç¨±é‚è¼¯ï¼š
     * 1. å„ªå…ˆæŠ“å–ç¶²å€åƒæ•¸ (?user=xxx)
     * 2. å…¶æ¬¡æŠ“å– GAS æ¨¡æ¿è®Šæ•¸ (<?= username ?>)
     * 3. æœ€å¾Œé è¨­ç‚º "testing"
     */
    const getUsername = () => {
      const urlParams = new URLSearchParams(window.location.search);
      const urlUser = urlParams.get('user');
      const gasUser = "<?= username ?>";
      
      if (urlUser) return urlUser;
      if (gasUser && !gasUser.includes("?")) return gasUser;
      return "testing"; 
    };

    const USERNAME = getUsername().trim();
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwp5gItIw-NJhLolDfYtrFAU-5imfU6dsU8mSMTNMWdgXSz8WbqDfKHgeLVV9rNC45C/exec";
    
    let allAssets = []; 
    let currentIslandNo = null;

    window.onload = function() {
      console.log("ç•¶å‰ä½¿ç”¨è€…:", USERNAME);
      fetchIslands();
    };

    // --- 1. å–å¾—è³‡ç”¢æ¸…å–® ---
    async function fetchIslands() {
      try {
        const response = await fetch(SCRIPT_URL, {
          method: "POST",
          body: JSON.stringify({ action: "fetchIslands", username: USERNAME })
        });
        allAssets = await response.json();
        
        if (!allAssets || allAssets.length === 0) {
          document.getElementById('islandContainer').innerHTML = 
            `<div style='background:white; padding:20px; border-radius:10px;'>æ‰¾ä¸åˆ°å±¬æ–¼ <b>${USERNAME}</b> çš„å³¶å¶¼ã€‚<br>è«‹æª¢æŸ¥è©¦ç®—è¡¨ Island_Assets æ˜¯å¦å·²å¡«å¦¥ã€‚</div>`;
        } else {
          renderLobby();
        }
      } catch (e) {
        document.getElementById('islandContainer').innerHTML = "é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ GAS éƒ¨ç½²æ¬Šé™æ˜¯å¦è¨­ç‚ºã€Œæ‰€æœ‰äººã€ã€‚";
      }
    }

    // --- 2. é¡¯ç¤ºå¤§å»³ ---
    function renderLobby() {
      const container = document.getElementById('islandContainer');
      container.innerHTML = "";
      
      const groups = {};
      allAssets.forEach(a => {
        if (!groups[a.islandNo]) groups[a.islandNo] = { name: a.islandName, bg: a.islandBG };
      });

      Object.keys(groups).forEach(no => {
        const item = groups[no];
        const card = document.createElement('div');
        card.className = 'island-card';
        card.style.backgroundImage = `url('${item.bg}')`;
        card.onclick = () => enterIsland(no);
        card.innerHTML = `<div>${item.name}</div>`;
        container.appendChild(card);
      });
    }

    // --- 3. é€²å…¥å³¶å¶¼å…§éƒ¨èˆ‡è®€å–å­˜æª” ---
    async function enterIsland(no) {
      currentIslandNo = no;
      showLoading(true);
      
      const islandData = allAssets.find(a => a.islandNo == no);
      const view = document.getElementById('islandView');
      const layer = document.getElementById('assetLayer');
      
      document.getElementById('lobby').style.display = 'none';
      view.style.display = 'block';
      view.style.backgroundImage = `url('${islandData.islandBG}')`;
      
      let savedPositions = null;
      try {
        const resp = await fetch(SCRIPT_URL, {
          method: "POST",
          body: JSON.stringify({ action: "fetchLastPosition", username: USERNAME, islandNo: no })
        });
        const result = await resp.json();
        if (result.positionData) savedPositions = JSON.parse(result.positionData);
      } catch (e) { console.log("ç¬¬ä¸€æ¬¡é€²å…¥ï¼Œç„¡æ­·å²å­˜æª”"); }
    
      layer.innerHTML = ""; 
    
      allAssets.filter(a => a.islandNo == no).forEach((asset, index) => {
        const img = document.createElement('img');
        img.src = asset.assetUrl;
        img.className = 'asset';
        img.dataset.assetName = asset.assetName; 
    
        let savedPos = savedPositions ? savedPositions.find(p => p.name === asset.assetName) : null;
        
        if (savedPos) {
          img.style.left = savedPos.x;
          img.style.top = savedPos.y;
        } else {
          img.style.left = (100 + index * 120) + "px"; 
          img.style.top = "250px";
        }
        
        makeDraggable(img);
        layer.appendChild(img);
      });
      
      showLoading(false);
    }

    // --- 4. å„²å­˜åº§æ¨™ ---
    async function savePositions() {
      showLoading(true);
      const assetsInView = document.querySelectorAll('.asset');
      let positions = [];
      assetsInView.forEach(el => {
        positions.push({ name: el.dataset.assetName, x: el.style.left, y: el.style.top });
      });
    
      const payload = {
        action: "saveIslandUpdate",
        username: USERNAME,
        islandNo: currentIslandNo,
        positionData: JSON.stringify(positions)
      };
    
      try {
        const response = await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify(payload) });
        const result = await response.json();
        if (result.result === "success") {
          alert("âœ¨ ä½ˆç½®å·²æˆåŠŸå„²å­˜è‡³é›²ç«¯ï¼");
        }
      } catch (e) { alert("å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥é€£ç·š"); }
      showLoading(false);
    }

    function backToLobby() {
      document.getElementById('islandView').style.display = 'none';
      document.getElementById('lobby').style.display = 'block';
    }

    function showLoading(show) {
      document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
    }

    // --- 5. æ‹–æ‹½é‚è¼¯ ---
    function makeDraggable(el) {
      let isDragging = false;
      let offset = { x: 0, y: 0 };

      const start = (e) => {
        isDragging = true;
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        offset.x = clientX - el.offsetLeft;
        offset.y = clientY - el.offsetTop;
      };

      const move = (e) => {
        if (!isDragging) return;
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        el.style.left = (clientX - offset.x) + "px";
        el.style.top = (clientY - offset.y) + "px";
      };

      const stop = () => isDragging = false;

      el.onmousedown = start;
      document.onmousemove = move;
      document.onmouseup = stop;
      el.ontouchstart = start;
      document.ontouchmove = move;
      document.ontouchend = stop;
    }
  </script>
</body>
</html>

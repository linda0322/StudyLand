<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <style>
    :root { --primary: #4db6ac; }
    body { font-family: sans-serif; margin: 0; overflow: hidden; background: #222; }
    
    /* å¤§å»³æ¨£å¼ */
    #lobby { padding: 20px; text-align: center; color: white; background: #f4f7f6; height: 100vh; overflow-y: auto; }
    .island-grid { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; padding: 20px; }
    .island-card { 
      width: 200px; height: 150px; background: white; border-radius: 15px; 
      cursor: pointer; position: relative; border: 4px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      background-size: cover; background-position: center;
    }
    .island-card div { position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.6); color: white; font-size: 14px; padding: 8px 0; border-bottom-left-radius: 11px; border-bottom-right-radius: 11px; }

    /* å³¶å¶¼å…§éƒ¨è¦–åœ– */
    #islandView { display: none; width: 100vw; height: 100vh; position: relative; background-size: cover; background-position: center; }
    .asset { position: absolute; cursor: move; width: 80px; transition: transform 0.1s; user-select: none; touch-action: none; }
    .asset:active { transform: scale(1.1); z-index: 1000; }
    
    /* å·¥å…·åˆ— */
    .toolbar { position: fixed; top: 10px; left: 10px; z-index: 100; display: flex; gap: 10px; }
    .btn { padding: 10px 20px; border-radius: 20px; border: none; cursor: pointer; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    .btn-save { background: #ff9800; color: white; }
    .btn-back { background: #607d8b; color: white; }
  </style>
</head>
<body>

  <div id="lobby">
    <h1 style="color: #333;">æˆ‘çš„å³¶å¶¼ç¾¤</h1>
    <div id="islandContainer" class="island-grid">æ­£åœ¨è¼‰å…¥é›²ç«¯å³¶å¶¼...</div>
  </div>

  <div id="islandView">
    <div class="toolbar">
      <button class="btn btn-back" onclick="backToLobby()">â¬… è¿”å›å¤§å»³</button>
      <button class="btn btn-save" onclick="savePositions()">ğŸ’¾ å„²å­˜ä½ˆç½®</button>
    </div>
    <div id="assetLayer"></div>
  </div>

  <script>
    const USERNAME = "<?= username ?>";
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwp5gItIw-NJhLolDfYtrFAU-5imfU6dsU8mSMTNMWdgXSz8WbqDfKHgeLVV9rNC45C/exec?p=island&user=testing";
    
    let allAssets = []; 
    let currentIslandNo = null;

    window.onload = fetchIslands;

    // --- 1. å–å¾—è³‡ç”¢æ¸…å–® ---
    async function fetchIslands() {
      // æª¢æŸ¥åå­—æ˜¯å¦æ­£ç¢ºæŠ“åˆ°
      console.log("ç›®å‰çš„ç”¨æˆ¶å (USERNAME):", USERNAME);
      
      if (!USERNAME || USERNAME === "<?= username ?>") {
        document.getElementById('islandContainer').innerHTML = 
          "<b style='color:red;'>éŒ¯èª¤ï¼šç¶²å€æ²’æœ‰æ”œå¸¶ä½¿ç”¨è€…åç¨±ï¼<br>è«‹ä½¿ç”¨ï¼šç¶²å€?p=island&user=testing</b>";
        return;
      }
    
      try {
        const response = await fetch(SCRIPT_URL, {
          method: "POST",
          body: JSON.stringify({ action: "fetchIslands", username: USERNAME })
        });
        
        allAssets = await response.json();
        console.log("å¾å¾Œç«¯æŠ“åˆ°çš„åŸå§‹è³‡æ–™:", allAssets);
    
        if (!Array.isArray(allAssets) || allAssets.length === 0) {
          document.getElementById('islandContainer').innerHTML = "æ‰¾ä¸åˆ°å±¬æ–¼ " + USERNAME + " çš„å³¶å¶¼è³‡æ–™ï¼Œè«‹æª¢æŸ¥è©¦ç®—è¡¨ã€‚";
        } else {
          renderLobby();
        }
      } catch (e) {
        console.error("Fetch å¤±æ•—:", e);
        document.getElementById('islandContainer').innerHTML = "é€£ç·šå¾Œç«¯å¤±æ•—ã€‚";
      }
    }

    // --- 2. é¡¯ç¤ºå¤§å»³ ---
    function renderLobby() {
      const container = document.getElementById('islandContainer');
      container.innerHTML = "";
      
      const groups = {};
      allAssets.forEach(a => {
        if (!groups[a.islandNo]) groups[a.islandNo] = { name: a.islandName, bg: a.islandBG };
      });

      Object.keys(groups).forEach(no => {
        const item = groups[no];
        const card = document.createElement('div');
        card.className = 'island-card';
        card.style.backgroundImage = `url('${item.bg}')`;
        card.onclick = () => enterIsland(no);
        card.innerHTML = `<div>${item.name}</div>`;
        container.appendChild(card);
      });
    }

    // --- 3. é€²å…¥å³¶å¶¼ä¸¦è¼‰å…¥åº§æ¨™ ---
    async function enterIsland(no) {
      currentIslandNo = no;
      const islandData = allAssets.find(a => a.islandNo == no);
      const view = document.getElementById('islandView');
      const layer = document.getElementById('assetLayer');
      
      document.getElementById('lobby').style.display = 'none';
      view.style.display = 'block';
      view.style.backgroundImage = `url('${islandData.islandBG}')`;
      layer.innerHTML = "<div style='color:white; padding:50px;'>è¼‰å…¥åº§æ¨™ä¸­...</div>";
    
      let savedPositions = null;
      try {
        const resp = await fetch(SCRIPT_URL, {
          method: "POST",
          body: JSON.stringify({ action: "fetchLastPosition", username: USERNAME, islandNo: no })
        });
        const result = await resp.json();
        if (result.positionData) {
          savedPositions = JSON.parse(result.positionData);
        }
      } catch (e) { console.log("ç„¡æ­·å²å­˜æª”æˆ–è®€å–å¤±æ•—"); }
    
      layer.innerHTML = ""; 
    
      allAssets.filter(a => a.islandNo == no).forEach((asset, index) => {
        const img = document.createElement('img');
        img.src = asset.assetUrl;
        img.className = 'asset';
        img.dataset.assetName = asset.assetName; 
    
        // å°æ‡‰åº§æ¨™é‚è¼¯
        let savedPos = savedPositions ? savedPositions.find(p => p.name === asset.assetName) : null;
        
        if (savedPos) {
          img.style.left = savedPos.x;
          img.style.top = savedPos.y;
        } else {
          img.style.left = (50 + index * 110) + "px"; 
          img.style.top = "200px";
        }
        
        makeDraggable(img);
        layer.appendChild(img);
      });
    }

    // --- 4. å„²å­˜åº§æ¨™ ---
    async function savePositions() {
      const assetsInView = document.querySelectorAll('.asset');
      let positions = [];
      
      assetsInView.forEach(el => {
        positions.push({
          name: el.dataset.assetName, 
          x: el.style.left,
          y: el.style.top
        });
      });
    
      const payload = {
        action: "saveIslandUpdate",
        username: USERNAME,
        islandNo: currentIslandNo,
        positionData: JSON.stringify(positions)
      };
    
      try {
        const response = await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify(payload) });
        const result = await response.json();
        if (result.result === "success") alert("é…ç½®å·²æˆåŠŸå­˜å…¥é›²ç«¯ï¼");
      } catch (e) {
        alert("å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚");
      }
    }

    function backToLobby() {
      document.getElementById('islandView').style.display = 'none';
      document.getElementById('lobby').style.display = 'block';
    }

    // --- 5. æ‹–æ‹½é‚è¼¯ (æ”¯æ´æ»‘é¼ èˆ‡è§¸æ§) ---
    function makeDraggable(el) {
      let isDragging = false;
      let offset = { x: 0, y: 0 };

      const start = (e) => {
        isDragging = true;
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        offset.x = clientX - el.offsetLeft;
        offset.y = clientY - el.offsetTop;
      };

      const move = (e) => {
        if (!isDragging) return;
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        el.style.left = (clientX - offset.x) + "px";
        el.style.top = (clientY - offset.y) + "px";
      };

      const stop = () => { isDragging = false; };

      el.onmousedown = start;
      document.onmousemove = move;
      document.onmouseup = stop;

      el.ontouchstart = start;
      document.ontouchmove = move;
      document.ontouchend = stop;
    }
  </script>
</body>
</html>

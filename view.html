<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>島嶼縮圖展示中心</title>
    <style>
        :root {
            --island-width: 800px;  /* 原始島嶼寬度 */
            --island-height: 600px; /* 原始島嶼高度 */
            --display-scale: 0.8;   /* 縮放比例 (0.8 代表顯示 80% 大小) */
        }

        body {
            margin: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f4f7f6;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .container {
            text-align: center;
        }

        h2 { color: #333; margin-bottom: 20px; }

        /* 島嶼外框 */
        #island-viewport {
            /* 根據比例自動計算顯示大小 */
            width: calc(var(--island-width) * var(--display-scale));
            height: calc(var(--island-height) * var(--display-scale));
            
            background-color: #a2d5f2; 
            background-image: url('image/island/background/first.webp'); /* 你的背景圖路徑 */
            background-size: cover;
            background-position: center;
            
            position: relative;
            overflow: hidden;
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
            border: 8px solid white;
            border-radius: 20px;
        }

        .loading-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 999;
            color: #555;
        }

        /* 家具物件的基本樣式 */
        .furniture-item {
            position: absolute;
            transform-origin: top left;
            pointer-events: none; /* 防止點擊影響 */
        }
    </style>
</head>
<body>

    <div class="container">
        <h2 id="user-title">訪客的島嶼</h2>
        
        <div id="island-viewport">
            <div id="loading" class="loading-overlay">
                <p>正在從雲端載入島嶼數據...</p>
            </div>
            </div>
        
        <p style="color: #888; margin-top: 15px; font-size: 0.9em;">
            網址加入 <b>?id=使用者名稱</b> 即可切換視角
        </p>
    </div>

    <script>
        // 1. 你的 GAS 部署網址
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzUHMVO7iwgvf1RONm3KB9C88HzlJZpqhZuZLqP3FIYQDb_WXBqDTdPOl_N_X9VtzAw/exec";
        
        // 2. 你的家具圖片資料夾路徑 (最後要有斜線)
        // 如果圖片在 GitHub，建議用完整網址，例如 https://linda0322.github.io/StudyLand/assets/images/
        const IMAGE_BASE_URL = "https://github.com/linda0322/StudyLand/tree/main/image"; 

        async function loadIsland() {
            const params = new URLSearchParams(window.location.search);
            const userId = params.get('id');
            const viewport = document.getElementById('island-viewport');
            const loading = document.getElementById('loading');
            const userTitle = document.getElementById('user-title');

            if (!userId) {
                loading.innerHTML = "<p style='color:red;'>錯誤：網址缺少用戶 ID<br>範例：view.html?id=linda</p>";
                return;
            }

            userTitle.innerText = `${userId} 的島嶼縮圖`;

            try {
                // 3. 獲取數據
                const response = await fetch(`${GAS_URL}?id=${userId}`);
                const layout = await response.json();

                if (!layout || layout.length === 0) {
                    loading.innerText = "此用戶尚未建立島嶼佈置";
                    return;
                }

                // 4. 清除現有家具 (除了 loading 遮罩)
                const oldItems = viewport.querySelectorAll('.furniture-item');
                oldItems.forEach(item => item.remove());

                // 5. 取得當前 CSS 定義的縮放比例
                const scale = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--display-scale'));

                // 6. 渲染佈置
                layout.forEach(item => {
                    const img = document.createElement('img');
                    img.className = 'furniture-item';
                    
                    // 組合圖片路徑
                    img.src = IMAGE_BASE_URL + item.name;
                    
                    // 計算縮放後的位置
                    const posX = parseFloat(item.x) * scale;
                    const posY = parseFloat(item.y) * scale;
                    const width = (item.w ? parseFloat(item.w) : 100) * scale;

                    img.style.left = posX + "px";
                    img.style.top = posY + "px";
                    img.style.width = width + "px";
                    img.style.zIndex = item.z || Math.floor(posY);

                    // 處理圖片載入失敗
                    img.onerror = () => { img.style.display = 'none'; console.log("圖片載入失敗:", item.name); };

                    viewport.appendChild(img);
                });

                // 成功載入後隱藏遮罩
                loading.style.display = 'none';

            } catch (error) {
                console.error("讀取失敗:", error);
                loading.innerText = "連線至 Google Sheets 失敗，請確認 GAS 權限已設為『任何人』";
            }
        }

        // 頁面開啟時執行
        window.onload = loadIsland;
        
        // 可選：每 30 秒自動刷新一次 (實現即時同步)
        // setInterval(loadIsland, 30000);
    </script>
</body>
</html>
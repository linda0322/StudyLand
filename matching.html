<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ÂúñÊñáÈÖçÂ∞ç</title>
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/linda0322/writingcloud/refs/heads/main/Icon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        @font-face {
            font-family: 'Cubic11';
            src: url('https://cdn.jsdelivr.net/gh/ACh-K/Cubic-11@90bc0e197c4db0fc8c75fe30c2d82dea03da707e/fonts/ttf/Cubic_11.ttf') format('truetype');
            font-display: swap;
        }
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            touch-action: manipulation; 
            -webkit-user-select: none; 
            overflow: hidden; 
            background-image: url('https://raw.githubusercontent.com/linda0322/writingcloud/refs/heads/main/Sky.png'); 
            background-size: cover; 
            background-position: center; 
            background-color: #38C0FF; 
            height: 100vh; 
        }
        .glass-panel { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.3); }
        
        .gallery-container { 
            display: flex; 
            flex-direction: column; 
            gap: 16px; 
            padding: 10px 4px 60px 4px; 
            overflow-y: auto; 
            height: 100%;
        }
        
        .level-card { 
            width: 100%; 
            border-radius: 24px; 
            overflow: hidden; 
            transition: transform 0.2s; 
            display: flex;
            flex-direction: row; 
            height: 120px;
            align-items: center;
            flex-shrink: 0;
        }
        .level-card:active { transform: scale(0.98); }

        .level-thumb {
            width: 80px;
            height: 100%;
            object-fit: contain;
            padding: 12px;
            margin-left: 10px;
        }

        .game-grid { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 8px; 
            width: 100%; 
            max-height: 80vh; 
            overflow-y: auto; 
            padding: 8px; 
        }
        .card { aspect-ratio: 3/4; perspective: 1000px; cursor: pointer; }
        .card-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); transform-style: preserve-3d; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-radius: 12px; }
        .card.flipped .card-inner { transform: rotateY(180deg); }
        .card.matched { opacity: 0; pointer-events: none; transform: scale(0); transition: all 0.5s ease-out; }
        .card-front, .card-back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; border-radius: 12px; padding: 4px; }
        
        .card-back { background: #38C0FF; color: white; border: 2px solid white; z-index: 2; }
        .card-front { background: linear-gradient(135deg, #ffffff 0%, #f0f9ff 100%); color: #38C0FF; font-size: 14px; transform: rotateY(180deg); }
        
        .card-img { width: 100%; height: 100%; object-fit: contain; border-radius: 8px; padding: 6px; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 100; padding: 20px; }
        .modal-overlay.active { display: flex; }
        .star-active, .star-inactive { 
                display: inline-block;
                width: 24px;
                height: 24px;
                background-size: contain;
                background-repeat: no-repeat;
                vertical-align: middle;
            }

            #result-stars .star-active, 
            #result-stars .star-inactive {
                width: 80px;
                height: 80px;
            }
            .star-active { 
                background-image: url('https://raw.githubusercontent.com/shuqikhor/pixel-icons/92a2d8ff3e9149b87404ec099a27fb90d7399bb9/icons/star.svg'); 
            }
            
            .star-inactive { 
                background-image: url('https://raw.githubusercontent.com/shuqikhor/pixel-icons/92a2d8ff3e9149b87404ec099a27fb90d7399bb9/icons/star-empty.svg'); 
                opacity: 0.5;
            }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .font-cubic { font-family: 'Cubic11', sans-serif; }
        .text-border {
            -webkit-text-stroke: 1px currentColor;
            paint-order: stroke fill;
        }
        .name-border {
            -webkit-text-stroke: 0.5px currentColor;
            paint-order: stroke fill;
        }
    </style>
</head>
<body class="flex flex-col items-center p-4">

    <div id="sync-status" class="fixed top-6 right-6 z-[100] glass-panel px-4 py-2 rounded-full shadow-lg flex items-center gap-2 opacity-0 transition-opacity duration-300">
        <div class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></div>
        <span id="sync-text" class="text-xs font-bold text-slate-600">ÂêåÊ≠•‰∏≠...</span>
    </div>

    <main class="w-full max-w-md h-full flex flex-col mt-[4vh] pb-6">
        <div class="mb-4 px-1 flex items-center justify-between shrink-0">
            <!-- È†ÇÈÉ®Â∑¶ÂÅ¥ -->
            <div id="top-left-container" class="flex items-center gap-2">
                <div id="user-info-panel" class="glass-panel px-4 py-1.5 rounded-full shadow-md flex items-center gap-2">
                    <span class="text-[10px] text-slate-500 font-cubic name-border uppercase tracking-wider">Â≠∏Áîü</span>
                    <span id="display-username" class="text-sm font-cubic name-border text-slate-700">ËºâÂÖ•‰∏≠...</span>
                </div>
                <button id="logout-btn" class="p-2 glass-panel rounded-full text-red-500 hover:bg-white/50 active:scale-90 transition-all shadow-lg">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                </button>
                
                <!-- ÈÅäÊà≤Ë®àÊôÇÂô® -->
                <div id="game-timer-panel" class="hidden bg-transparent px-1.5 py-2 flex items-center justify-start gap-2">
                    <div id="timer" class="text-2xl font-cubic text-border text-white">00:00</div>
                </div>
            </div>

            <!-- È†ÇÈÉ®Âè≥ÂÅ¥ÊåâÈàï -->
            <div class="flex gap-2 items-center">
                 <button id="reload-btn" onclick="location.reload()" class="p-2 glass-panel rounded-full text-slate-500 hover:bg-white/50 active:scale-90 transition-all shadow-lg">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
                </button>
                 <button id="back-to-gallery" class="hidden p-2 glass-panel rounded-full text-slate-500 shadow-lg hover:bg-white/50" onclick="showGallery()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                </button>
                <button id="reset-btn" class="hidden px-4 py-2 glass-panel text-slate-600 rounded-full hover:bg-white transition-colors font-cubic name-border text-xs shadow-lg active:scale-95" onclick="resetGame()">ÈáçÁé©</button>
            </div>
        </div>

        <div id="gallery-view" class="hidden flex flex-col flex-1 overflow-hidden">
            <div class="gallery-container scrollbar-hide" id="levels-list"></div>
        </div>

        <div id="game-view" class="hidden flex flex-col flex-1 overflow-hidden">
            <div class="hidden justify-between items-center mb-4">
                <div class="flex items-center gap-3 glass-panel px-4 py-2 rounded-full shadow-lg">
                    <span id="level-title" class="text-[10px] text-blue-500 font-bold uppercase">ÈóúÂç°</span>
                    <span id="match-count" class="text-xl font-black text-slate-700">0</span>
                    <span id="total-pairs" class="text-xs text-slate-400">/ 10</span>
                </div>
            </div>
            <div id="game-container" class="game-grid scrollbar-hide flex-1"></div>
        </div>
    </main>

    <!-- ÁôªÂÖ•ÂΩàÁ™ó -->
    <div id="user-modal" class="modal-overlay">
        <div class="bg-white p-8 rounded-[40px] shadow-2xl w-full max-w-xs text-center flex flex-col items-center">
            <img src="https://raw.githubusercontent.com/linda0322/writingcloud/refs/heads/main/Robot.gif" alt="Ê©üÂô®‰∫∫" class="w-24 h-24 mb-6">
            <h2 class="text-xl font-cubic text-border text-slate-700 mb-4">ÁôªÂÖ•</h2>
            <input type="text" id="username-input" placeholder="Ë´ãËº∏ÂÖ•‰Ω†ÁöÑÂêçÂ≠ó" class="w-full border-2 border-slate-100 rounded-2xl px-4 py-4 text-center font-cubic name-border mb-6 outline-none focus:border-[#38C0FF]">
            <button id="confirm-user" class="w-full py-4 bg-[#38C0FF] text-white rounded-2xl font-cubic name-border shadow-[#38C0FF]/10">ÈñãÂßãÈÅäÊà≤</button>
        </div>
    </div>

    <div id="result-modal" class="modal-overlay">
        <div class="bg-white p-8 rounded-[40px] shadow-2xl w-full max-w-xs text-center flex flex-col items-center">
            <div id="result-stars" class="mb-4 flex gap-1"></div>
            <p id="result-time" class="text-slate-500 mb-6 font-cubic">ÂÆåÊàêÊôÇÈñì 00:00</p>
            <button onclick="showGallery()" class="w-full py-4 bg-[#38C0FF] text-white rounded-2xl font-cubic name-border shadow-[#38C0FF]/10">ËøîÂõû</button>
        </div>
    </div>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbyw6uG_CLmIM_CMV5Tq3iWmj3kdjTD841DMZ95XEaeRIQPaxqolMmlVkYNm_cPmrMe_/exec";

        let levels = [
            { 
                id: 'wood1', name: 'Êú®ÈÉ®Ôºà‰∏ÄÔºâ', icon: 'ü™µ', thumbnail: 'https://raw.githubusercontent.com/shuqikhor/pixel-icons/92a2d8ff3e9149b87404ec099a27fb90d7399bb9/icons/apple-tree.svg',
                pairs: [ 
                    { zh: "Ê°åÂ≠ê", img: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj2vVy6qufcVwEgmBn0lQ13bNjIWGDBjgtzw1yop_ppR6K3e-gsmmZxwG_NuPQRMFJRefcLf9T1FDvytx61TFpry9pxRWRfB7KEHfUqWgCiRrUe0Y_vCfzv7ew8kQ3p317yxwC0mHn1ThBK/s800/desk_book.png" }, 
                    { zh: "Ê¢®Â≠ê", img: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj1Snh-pHbogpnOQcjKUC5WGLRnUM66zWNZlim5bNU__zoyvQcbiixj0o3Hnu_Z0Ilgn0K_A1ssNRb91Hndr51A0mEk4l-1cVU74mfRvRu6LqiJfdRRRUgWXV0V_fTo-i42FK7Dz32r96A/s800/fruit_chugoku_nashi.png" }, 
                    { zh: "Êõ∏Ê´É", img: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgNl8O_TzTIG9QjkF9iqKDpSbx025gVVBczo2UrIOCs523HlrWjY_kl1sxPP4f_2i8d6vplw7vYyj2UgK4AYSNky7XqmJ48kcQzjKFT_hl1F4wktme_JhDVdC-CEQTjehIyI_YwaVW8fWSs/s800/tosyokan_book_tana.png" }, 
                    { zh: "Ëæ£Ê§í", img: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi7cvuaI7YyDn3yzdCJq4NNzB6E5sWpkylreOxATVAOpfHVfCqa_cQfF7xkxXuWTa4l2toYR6I1DGEHE0oKalvQs_6U3_HoA5pnL-AfKoVPReKU7J9LuzlwWnnmWfmUmWR1O0o8_hhlaZeE/s800/tougarashi_redpepper.png" }, 
                    { zh: "Ê§∞Â≠ê", img: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhoVm07WHBlDyQdQR-RJDPzZQtEin3_O8_Rq_fr-zpJWdCR-iTwLs2wzfyyXLEz9cBPEa2VnwzRBfnUug3LgZnKZrEJzS54C_SwN255VI1vAbBNB6d3Abev18P5bESkdGYp0KRtlCPq7t__/s1600/fruit_coconut_half.png" }, 
                    { zh: "Ê•äÊü≥", img: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgSTVEIaZuK5nz__bdKOwr5l09s2PXKFO28zufU1yrLTHjAJ5ZZAGEurl-62AvOsDHUS4uW_Dpv4zBBlaOSDdUGKJh_T6RRKd1rvWI6g1PkY0VaFjncM1It00bM8BkxRZauOSU18X2bydnP/s800/tree_shidare_yanagi.png" },
                    { zh: "Ê¢ÖËä±", img: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjSJTlGOxfgZwX_mYREF9n9cXHoz2BpPR4uK3GWb3AmHaMVq1gudeQ6TsmiaJ6FQz9HKbsIGhkB9x4KZu2VT5a19_Nv3OSA4HJ74Q9LWavfh758cffqFkUlnFn7VyrjFG2nDSKgBNP6xfuG/s800/flower_ume_kaika.png" },
                    { zh: "ÊûúÂØ¶", img: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEilqhbReGQT2DKIVUvjUTXWudlbIBvj_UNmv_uCQL3GR5E1Lum0zROzmgw7Z9CYWHoQj6PUoxOk_qb3tJqtUmXQJekcVwlIlhR7eIrz0c4oJlCTRBidOFm7DY3DyEopIHsXhXJjH-eYSx4/s800/fruits_basket.png" },
                    { zh: "ÁõÜÊ†Ω", img: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjfA2a6DiWQXEiABf0fZsAjzB2b9WSKk0joJpEtFy_HwC0oD0f3fkrZrRhsk7-gyu_tWCk5F5iZf_9gYnHZ4qMquwq2QBwtTM2YKQLzpdolbAwwbfkKOVuelO4mwIcjILPX3WX2uZh5bwY/s800/flower_surfinia_safinia+.png" },
                    { zh: "Ê¨ÑÊùÜ", img: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjuVlwp8VERYX2VAxcsFJZyo3oiMxmSa9gEaqG_IMhG79eqbgJ38opsq0QaFor-jKXx_M5v-WhxNrfI-wOEk65HkYfbqTFnE27jqleruBXcCJzyjpxdebR43C1JPImSHKPyhWehmAu9jrc/s800/ihan_saku_norikoeru.png" }
                ] 
            },
            { 
                id: 'wood2', name: 'Êú®ÈÉ®Ôºà‰∫åÔºâ', icon: 'üå¥', thumbnail: 'https://raw.githubusercontent.com/shuqikhor/pixel-icons/92a2d8ff3e9149b87404ec099a27fb90d7399bb9/icons/sakura-tree.svg',
                pairs: [ 
                    { zh: "Êú®Êùê", img: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjo7TN9LCVKD620pWFCnzjdMrgeaWfp6XOeOyqkVZL2qEUIo2Y_55ZztJlC74OGScUr4ceS57vOvZd_B22qzpVyJQSODFKJ_pwE4OkGSItMVnPyC_ONbED2v5mO1J5DrJIfIjqAoib7rvI/s800/wood_maruta.png" }, 
                    { zh: "Â§ßÊ®π", img: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhpqy4lZlKBo6VgFAwjEXkmYLA0uG3i0l8YhHJE4bu88kS58Mw3oZIAAtGG6y6fj48hz11yZoUv8MSUUyKgxb-R1NfbGTlw1oO3ZCGalEsHlUvc6OCSZT63c5rUnEUhsV-A_NXMrzfC5Zw/s800/tree_keyaki.png" }, 
                    { zh: "Â§ßÊ®ì", img: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi4obsY_J-Eyf4kgK-NrPChwY1-XVaWcWlrhQlsaWoxfJaVIc8QHC-4I8n8een7nMit4wUemj-cw5aGEIvGnp21ZProJxy24WThwqrjfDb-t6mrH4Y7G3F-IaNHivzj07ouNoRq1LFUuIsO/s800/building.png" }, 
                    { zh: "Ê£ÆÊûó", img: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhJcDbc8m-8N272agxxY_OxD_wx8Yd7ej-a1oLvbkqY_vV-pedJTucl31tMyUxFQ4_urlaCS9cxNa5J95wutPcwxWXrgQhYv508_7YVZ02XyU8fi6r8xGlC5GbrSCFRQqhgxwxbSZCmZJ8/s800/kouyou_tree.png" }, 
                    { zh: "Ëä±Êúµ", img: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhZmfZ9R4cG9csWKYUA72GMevvbPvQjOCIxaZlL3DJlIOsso0B1A7eaenLZhOL2cPrezRvV6xFRjJkrP_eJc8A9cFiTAcO_pVqEI8tIyuB-a5z1CQ7Rn1RndCpgMMNYTA8OM7UdWTxkAS4/s800/flower_cosmos.png" }, 
                    { zh: "Ê®πÊ†π", img: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj22-mR1GoYYRFLkhjiC3P7Ubl1scaswqHRx5UfwKXnYj_aKudfP8heEKZecGrC_sG8VzUJms3r_TUKs1Bl4NLGXn_hLja7yw-rQzxoE13rFercdoFkonFVDPYNXyLVLp4t3Lj-9TJwgXA9/s767/tree_root_green_nobg.png" },
                    { zh: "Ê†∏Ê°É", img: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj40KGGr2ZUkRXRD-8Nr15FJzo5gZa1Y2ubZnqpzpmqEtufLbyjZ6xmw8nZxNAAEVTcxAqefg7Jb-RxPpRNbPjiVV58vuLE_z0RhpLlcHitp33pEj5wVP1mpy989XWTjmoUBjXJw_Y17Kk/s800/nuts_kurumi.png" },
                    { zh: "Â§ßÊ©ã", img: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhLBglHRopbkO7FvVspc7_dYliFAQVVmd4fgknUft-LqmFil1X_jWyFc1H9a_A69NyU-q13n_mPoII9ukkRPKomgbDWWGSV79satqxIfWOX8IgXzgmC5dDNKNiwDfE6TBpfoEyPbkL_C9V3/s800/landmark_golden_gate_bridge.png" },
                    { zh: "Â≠∏Ê†°", img: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgJa70lbnuP2paN7aManaWTWvISVAb1j3C1b2mXz-H_kLlstiE2rhwDQAT4WSqOZPxrYgZirbjUfFXDDaTPlPfsv6ucMk0untZu7zcH7UEGID4LnOvEOzIUOSTAo_-kvHcl49DnmUPfpqo/s1600/school.png" },
                    { zh: "Ê§ÖÂ≠ê", img: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiZyrTkpr3LoNifVcXZ21kESg4o984PFyR-WVLrUyHUOoLXkBbjiNtl2OlRysoFgobwpJtYIKp17LnIkZP0B20ZKQu5JrM7_x-6hqgg_O2CLSs9HYxUuHoreuD_g97UtwicKViAveI9hhER/s800/gakkou_isu_chair.png" }
                ] 
            },
            { 
                id: 'animal1', name: 'ÂãïÁâ©Ôºà‰∏ÄÔºâ', icon: 'üôà', thumbnail: 'https://raw.githubusercontent.com/shuqikhor/pixel-icons/92a2d8ff3e9149b87404ec099a27fb90d7399bb9/icons/monkey-love.svg',
                pairs: [ 
                    { zh: "ËÄÅÈº†", img: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhYwXeke50-11ShPZF6t72EdnAKblh2m29aidS6dYDcz8LEFu8kr7vVACwejM_4OVt8EbdPyeJfwrmMDjfvBQZ57jS-Q-pYzq0Qa75hCNrS3SEb3jxVBDXZXgJerVK2qoE_rTU5InF4MuFL/s1600/animal_character_nezumi_cheese.png" }, 
                    { zh: "ÁçÖÂ≠ê", img: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgqNDRvN2WnwOYU152QDkr7t1V1zSS_SBq_iO1LpgZwtxKUzXOAuVrYjUt2y3LJYYZPEwD8maxSedL3mi9jSXVJnyLQ2J0nU2PnR4-0UyM6HzcxRNwjHgwDbRq9C3IxJvq6v_O4dUSAPakV/s1600/animal_chara_lion_king.png" }, 
                    { zh: "ËÄÅËôé", img: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjm2-_eXVjEvYx4Ma7Z9FIVnROdu31Guh5VzJ1musaitxxmct5i6Z6CowFVcXliUult_a9kKrZPXw1f_xCsnhrdrE2oNMdtFB6IbTgan5RPEbXSbE0Aqf9h54EjqKGNu2N29RvPKWdxK_U/s800/animal_stand_tora.png" }, 
                    { zh: "ÁãêÁã∏", img: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjXT7fcrfGnQ0VyXbjrWb6vRFepSarCJ8pnhjmuHbre8G0-K4dzTxcYKGGXGJZddCDy_ObMIxCr7SMi9SPEdH9dvYZvSs8s42WcL8nTqhGAnyRKPj280S0EBqjHHlvN-XqNLnAd_PhvKBI/s800/animal_fox_kitsune.png" }, 
                    { zh: "ÈáéÈ¶¨", img: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjO4MITeCu1xs7ze7ct_-kVgJAYsIBz3B5Km1q_NX2wWopxi6LSvVP-L30ErrwrH69pNRz-_vRT8VCWywuJiu3jbUcwzbSPzA8f5vBdbfCXgqSEkoUus80vx-ERElDIFlIJ6M7F4k2vfy93/s922/animal_uma_horse_stand.png" }, 
                    { zh: "Á∂øÁæä", img: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhe1bRRwgdm4USj2FX5PTXTFrwE3wO1AdN9Ur3Kq3GFDEDWFuNYpYfBlxdrwCR4_0Bnq2wp83pq_z34XrupZN4xfus5wICApTB8oRegSZNN1T93GeOp9f86ykDAjghhJsQ8nTXXiiPuygwn/s800/eto_remake_hitsuji.png" },
                    { zh: "Áå¥Â≠ê", img: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhUouTdx4TTWuiBhptpG1pTHE-qKfsQP865jlm_-TRNeGwgDMC61H4jPjGGLjY9GgEzAG7uiMxTpI9Khjp14j0r0lCIF7F3TXi-rk2w1-9mlcRfUP-Fr_7nCYFAfN7mA5AnG_nCcfx2mm4/s800/animal_monkey_kinobori.png" },
                    { zh: "ÂÖ¨Èõû", img: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhugpMvQYTwORyEPiv79itvDimBE-OuHSjbrU5BtnSRijly6_H0PfGEWNbWgKSenjBq8Y2IGNFUPs1bJ-Lba7dW_R2Avw8YbfuO3Y1QIz8UcMFXoWr-XvzHl2PxnpNbQlXvsn6oc7x4a89x/s800/eto_remake_tori.png" },
                    { zh: "ÈùíËõô", img: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhBPpULN6WK0WLk-XpmZ8lApfk_bZFGE4z6XvUtzARcKIXyXQO00z0BYmcofmzktwG5E4eNgQyDOcVPpD4cb6uOVBirX8Ir8xWANhuXjT4l5dY3TqpHqELb-jpFPDCFNHpJce2CX8JHob4p/s800/kaeru5_seitai.png" },
                    { zh: "Â∞èË±¨", img: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjodzIQI41R0TS6twnQkzX9wpUpoU6EHzvsKu72vLyYilBinJi32efMqh60yfG0l6CDRCTghDXZVaTFSR5K-gBK0NcBaDO4PeDDGFnj__3wtonL6ZWJe6kaqrdPXsIAXmUiNGff7Ljde_CC/s800/kotowaza_buta_shinju.png" }
                ] 
            },
            { 
                id: 'fruit1', name: 'Ê∞¥ÊûúÔºà‰∏ÄÔºâ', icon: 'üçì', thumbnail: 'https://raw.githubusercontent.com/shuqikhor/pixel-icons/92a2d8ff3e9149b87404ec099a27fb90d7399bb9/icons/banana.svg',
                pairs: [ 
                    { zh: "Ë•øÁìú", img: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgcz6CLn1iHUeTSrZWlJym-AvdVkM-p9p-JakM8O2zlLG5SK2huWJkJRVqAwKmH9Y6TRVT0U6mTWOazwxAP3eYwKZhmxlelkrLyFwYudXINXsh2jcI-OFbl-zh9TUKnuo8J3wvALY1pQhVS/s1600/fruit_suika_red.png" }, 
                    { zh: "Ê¶¥Êß§", img: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiG2yCzvgu8d8y-xz7FF0BafrSOn2yrvLKEx6MiMHZcG-aVGyfTosv_C1K8eMT1j_uCEd5J0MiEs2yGLYwCjuTTJR5EG24VqY7EFT_3Vcdnamn4U0PpAe0vmPMoIy7Lcgy0VVz5nDWTTC_j/s800/fruit_durian.png" }, 
                    { zh: "ËçâËéì", img: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi16xaBrly6jqbVAhvgAWn-JdGhVIRXmatPCrcV8n742YEMOFnD6bq17TlSDPNZ-cSQEqXSrXlGKFkksGW0JL2CuRk1uHaC58YE2MKMfbeEoUDADcIUikvNVZ1LzeHQEG4EX3_eQ30kvoRm/s800/fruit_strawberry.png" }, 
                    { zh: "ËóçËéì", img: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiTz-i3Fy81KgD2kzTLBGK3iDpoEc86CSzDSPjO3MabXvLFHRKUxiN9Y8YbRkCVKABM7l7aiSAB1K4R7DHjzxmfC8kcy9v_p_hHXSC3SOgF8Qu5NRtA0jXwQz0UmkmSGtFCcenOiW93bcMH/s800/character_blueberry.png" },
                    { zh: "ËòãÊûú", img: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgvJ8nlAjtvyl8jap55PKPnJt__ggEPtiLoMoqmaGZDiS45yB2LbJUHK7GHHAZ-vsJPHqP79zoCC2BXO8KgnGoMnbj8Rjpme8VKVgidzNbd7vQfaJ_VXIud3UJQ9FMf0yRoS8Mkq5u0M44P/s800/color01_red_apple.png" }, 
                    { zh: "È¶ôËïâ", img: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjDTy81qEYQ7MLvImTaqiWn_8Wu16qPSIVeJP0Aae64gv07aXn1vB7bYczEbPjMqj-CEgAe9DMTD4KkQ2kq83y1tYUcJF3RbF7LJAe0qZLRVwd667uFMHukkjcEC1rzWheoOtGI1eqhCywi/s800/fruit_banana.png" }, 
                    { zh: "Ëè†Ëòø", img: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgaaUwzdP0LHRtptl4oo6U8pWKzog1t7PtkUTkjKX4E36YrMdL4abwRoozLeFKctq1FVWpWhfnWBJy4DR9vxl19NstMH4zfeVehF262USm9k5jnGXoATrWdLLLTEeDjETviTGvIKuJ9E9nh/s800/fruit_pineapple.png" }, 
                    { zh: "ÁÅ´ÈæçÊûú", img: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjSBNjc2nj-8SqBldTv7bhzhVQYGQTmIX1fD4WwLqw8Zt7IdUEbjIQ4jCEzWlg95Jr3SwDpfuLLCS6TN9P9-zn4SXZ68TgPTxGLSphinyJKo3bF-d-zLjzxSQT8o3CdpoF4QTVq3nqOgi-f/s800/fruit_dragonfruit.png" }, 
                    { zh: "Êú®Áìú", img: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjA-0PcG6IF_ByNvvECEErsKnpnDYAtkwJ45r5g0U1LT-3gPlKixHxXMUD6QlZAnWKQVp8LzEqH2c7KO2585Q5gs70PpJjyR3FRAVI_9ngvPjdXs_4vVmVqhTqU8cXjpmiZR2Kxwggs7mqG/s800/fruit_papaya_green.png" }, 
                    { zh: "ËäíÊûú", img: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjy0Y1oRydZ4JTBQbaWfVC_m1cjcPDzzEKjSYex1Hz2HsX6VFT1RYR9I2hO4Nxr7xL_FPXx2NWv0i75fR9RGvqFXljsowCgTJIsuNmhqFEOXpTuq3d1jkfKQwM2kB1YsIC-G1NyyZVHHEY5/s800/fruit_mango.png" }
                ] 
            },
        ];

        let currentLevel = null, flippedCards = [], matchedCount = 0, isProcessing = false, seconds = 0, timerInterval;

        const galleryView = document.getElementById('gallery-view'), 
              gameView = document.getElementById('game-view'), 
              levelsList = document.getElementById('levels-list'), 
              gameContainer = document.getElementById('game-container'), 
              matchCountEl = document.getElementById('match-count'), 
              timerEl = document.getElementById('timer'), 
              syncStatus = document.getElementById('sync-status'), 
              syncText = document.getElementById('sync-text'),
              userInfoPanel = document.getElementById('user-info-panel'),
              logoutBtn = document.getElementById('logout-btn'),
              gameTimerPanel = document.getElementById('game-timer-panel');

        function parseDuration(val) {
            if (!val) return "--:--";
            if (typeof val === 'string' && (val.includes("GMT") || val.includes("1899"))) {
                const match = val.match(/(\d{2}):(\d{2}):(\d{2})/) || val.match(/(\d{2}):(\d{2})/);
                if (match) return match.length === 4 ? `${match[2]}:${match[3]}` : match[0];
            }
            if (typeof val === 'string' && val.includes(":")) {
                const parts = val.split(':');
                return parts.length === 3 ? `${parts[1]}:${parts[2]}` : val;
            }
            return val.toString();
        }

        function initApp() {
            const savedName = localStorage.getItem('match_username');
            if (!savedName) {
                document.getElementById('user-modal').classList.add('active');
                galleryView.classList.add('hidden');
            } else {
                document.getElementById('display-username').innerText = savedName;
                fetchRecords(savedName);
            }
        }

        async function fetchRecords(name) {
            syncStatus.style.opacity = '1'; syncText.innerText = 'ÂêåÊ≠•‰∏≠...';
            try {
                const res = await fetch(`${GAS_URL}?name=${encodeURIComponent(name)}`);
                const data = await res.json();
                levels.forEach(l => {
                    localStorage.removeItem(`best_${l.id}`); localStorage.removeItem(`best_sec_${l.id}`); localStorage.removeItem(`best_stars_${l.id}`);
                });
                Object.keys(data).forEach(lvlId => {
                    const cleanTime = parseDuration(data[lvlId].time);
                    if (cleanTime && cleanTime.includes(":")) {
                        localStorage.setItem(`best_${lvlId}`, cleanTime);
                        localStorage.setItem(`best_sec_${lvlId}`, data[lvlId].seconds);
                        localStorage.setItem(`best_stars_${lvlId}`, data[lvlId].stars); 
                    }
                });
                syncText.innerText = 'Â∑≤ÂêåÊ≠•'; showGallery(); setTimeout(() => syncStatus.style.opacity = '0', 1000);
            } catch (e) {
                syncText.innerText = 'Â∑≤Èõ¢Á∑ö'; showGallery(); setTimeout(() => syncStatus.style.opacity = '0', 2000);
            }
        }

        function showGallery() {
            galleryView.classList.remove('hidden'); gameView.classList.add('hidden');
            document.getElementById('result-modal').classList.remove('active');
            document.getElementById('back-to-gallery').classList.add('hidden');
            document.getElementById('reset-btn').classList.add('hidden');
            document.getElementById('reload-btn').classList.remove('hidden');
            
            userInfoPanel.classList.remove('hidden');
            logoutBtn.classList.remove('hidden');
            gameTimerPanel.classList.add('hidden');

            clearInterval(timerInterval); renderLevels();
        }

        function calculateStars(sec) { return sec <= 60 ? 3 : (sec <= 120 ? 2 : 1); }
        function getStarsHtml(count) {
            let h = '';
            for(let i=1; i<=3; i++) h += `<span class="${i <= count ? 'star-active' : 'star-inactive'}"></span>`;
            return h;
        }

        function renderLevels() {
            levelsList.innerHTML = '';
            levels.forEach(lvl => {
                const best = parseDuration(localStorage.getItem(`best_${lvl.id}`) || '--:--');
                const starCount = parseInt(localStorage.getItem(`best_stars_${lvl.id}`) || '0');
                const card = document.createElement('div');
                card.className = `level-card bg-white shadow-lg cursor-pointer`;
                card.innerHTML = `
                    <img src="${lvl.thumbnail}" class="level-thumb" onerror="this.src='https://raw.githubusercontent.com/linda0322/writingcloud/refs/heads/main/Icon.png'">
                    <div class="flex-1 px-5 flex flex-col justify-center h-full">
                        <div class="flex justify-between items-start mb-1">
                            <h3 class="text-xl text-slate-700 font-cubic text-border">${lvl.name}</h3>
                            <span class="hidden text-2xl">${lvl.icon}</span>
                        </div>
                        <div class="flex items-center justify-between mt-1">
                            <div class="flex gap-1">${getStarsHtml(starCount)}</div>
                            <div class="flex items-center gap-2">
                                 <div class="px-2 py-0.5 rounded-full bg-slate-50 text-[10px] text-[#38C0FF] font-cubic font-bold shadow-sm">BEST</div>
                                 <span class="text-sm font-cubic font-black text-slate-500">${best}</span>
                            </div>
                        </div>
                `;
                card.onclick = () => startLevel(lvl);
                levelsList.appendChild(card);
            });
        }

        function startLevel(lvl) {
            currentLevel = lvl;
            galleryView.classList.add('hidden'); gameView.classList.remove('hidden');
            document.getElementById('back-to-gallery').classList.remove('hidden');
            document.getElementById('reset-btn').classList.remove('hidden');
            document.getElementById('reload-btn').classList.add('hidden');
            document.getElementById('level-title').innerText = lvl.name;

            userInfoPanel.classList.add('hidden');
            logoutBtn.classList.add('hidden');
            gameTimerPanel.classList.remove('hidden');

            resetGame();
        }

        function resetGame() {
            gameContainer.innerHTML = ''; flippedCards = []; matchedCount = 0;
            matchCountEl.innerText = '0';
            document.getElementById('total-pairs').innerText = `/ ${currentLevel.pairs.length}`;
            isProcessing = false;
            
            let data = [];
            currentLevel.pairs.forEach((p, i) => {
                data.push({ c: p.img, id: i, t: 'img' });
                data.push({ c: p.zh, id: i, t: 'txt' });
            });
            data.sort(() => Math.random() - 0.5);

            data.forEach(d => {
                const card = document.createElement('div');
                card.className = 'card';
                card.dataset.id = d.id; card.dataset.type = d.t;
                card.innerHTML = `<div class="card-inner">
                    <div class="card-back"><span class="text-6xl">${currentLevel.icon}</span></div>
                    <div class="card-front">${d.t==='img'?`<img src="${d.c}" class="card-img">`:`<div class="font-bold text-center text-2xl leading-tight break-words px-1">${d.c}</div>`}</div>
                </div>`;
                card.onclick = () => handleCardClick(card);
                gameContainer.appendChild(card);
            });
            startTimer();
        }

        function startTimer() {
            clearInterval(timerInterval); seconds = 0; timerEl.innerText = '00:00';
            timerInterval = setInterval(() => {
                seconds++;
                const m = Math.floor(seconds/60).toString().padStart(2,'0'), s = (seconds%60).toString().padStart(2,'0');
                timerEl.innerText = `${m}:${s}`;
            }, 1000);
        }

        function handleCardClick(card) {
            if (isProcessing || card.classList.contains('flipped') || card.classList.contains('matched')) return;
            card.classList.add('flipped');
            flippedCards.push(card);
            if (flippedCards.length === 2) {
                isProcessing = true;
                const [c1, c2] = flippedCards;
                if (c1.dataset.id === c2.dataset.id && c1.dataset.type !== c2.dataset.type) {
                    setTimeout(() => {
                        c1.classList.add('matched'); c2.classList.add('matched');
                        matchedCount++; 
                        matchCountEl.innerText = matchedCount;
                        flippedCards = []; isProcessing = false;
                        if (matchedCount === currentLevel.pairs.length) finishGame();
                    }, 600);
                } else {
                    setTimeout(() => {
                        c1.classList.remove('flipped'); c2.classList.remove('flipped');
                        flippedCards = []; isProcessing = false;
                    }, 1000);
                }
            }
        }

        async function finishGame() {
            clearInterval(timerInterval);
            const stars = calculateStars(seconds);
            const bestSecKey = `best_sec_${currentLevel.id}`;
            const curBest = localStorage.getItem(bestSecKey);
            
            if(!curBest || seconds < parseInt(curBest)) {
                localStorage.setItem(`best_${currentLevel.id}`, timerEl.innerText);
                localStorage.setItem(bestSecKey, seconds.toString());
                localStorage.setItem(`best_stars_${currentLevel.id}`, stars.toString());
            }
            
            syncStatus.style.opacity = '1'; syncText.innerText = 'Êõ¥Êñ∞‰∏≠...';
            await fetch(GAS_URL, { 
                method: 'POST', mode: 'no-cors', 
                body: JSON.stringify({ name: localStorage.getItem('match_username'), level: currentLevel.id, time: timerEl.innerText, stars: stars }) 
            });
            
            document.getElementById('result-stars').innerHTML = getStarsHtml(stars);
            document.getElementById('result-time').innerText = `ÂÆåÊàêÊôÇÈñì ${timerEl.innerText}`;
            document.getElementById('result-modal').classList.add('active');
            
            setTimeout(() => {
                syncText.innerText = 'Â∑≤ÂÆåÊàê';
                setTimeout(() => syncStatus.style.opacity = '0', 1000);
            }, 1000);
        }

        document.getElementById('confirm-user').onclick = () => {
            const n = document.getElementById('username-input').value.trim();
            if (n) { 
                localStorage.setItem('match_username', n); 
                document.getElementById('user-modal').classList.remove('active'); initApp(); 
            }
        };

        document.getElementById('logout-btn').onclick = () => { if(confirm("Á¢∫ÂÆöË¶ÅÁôªÂá∫ÂóéÔºü")) { localStorage.clear(); location.reload(); } };
        window.onload = initApp;
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
                         /*-- ç¶²é å¯¬åº¦=è£ç½®è¢å¹•å¯¬åº¦ --*/  /*-- 1:1 --*/     /*-- ç¸®æ”¾1å€ --*/   /*-- ç¦æ­¢æ‰‹æŒ‡ç¸®æ”¾ --*/ /*-- ç¶²é å…§å®¹å¡«æ»¿è¢å¹• --*/
    
    <title>åœ–æ–‡é…å°</title>
    
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/linda0322/StudyLand/refs/heads/main/image/man_icon.png">
    <script src="https://cdn.tailwindcss.com"></script>

    /**-- é è¨­ï¼šæ€æºé»‘é«” --*/
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700&display=swap" rel="stylesheet">
    
    <style>
        @font-face {
            font-family: 'Cubic11';
            src: url('https://cdn.jsdelivr.net/gh/ACh-K/Cubic-11@90bc0e197c4db0fc8c75fe30c2d82dea03da707e/fonts/ttf/Cubic_11.ttf') format('truetype');
            font-display: swap;
        }
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            touch-action: manipulation; 
            -webkit-user-select: none; 
            overflow: hidden; 
            background-image: url('https://raw.githubusercontent.com/linda0322/writingcloud/refs/heads/main/Sky.png');
            background-color: #38C0FF;
            background-size: cover;
            background-position: center;
        }
        .pixel-font { font-family: 'Cubic11', sans-serif; }
        .card { perspective: 1000px; cursor: pointer; transition: transform 0.2s; }
        .card:active { transform: scale(0.95); }
        .card-inner { transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); transform-style: preserve-3d; position: relative; width: 100%; height: 100%; }
        .card.flipped .card-inner { transform: rotateY(180deg); }
        .card.matched { opacity: 0; pointer-events: none; transform: scale(0); transition: all 0.5s ease-out; }
        .card-front, .card-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 1.5rem; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 15px -3px rgba(0,0,0,0.1); }
        .card-front { background: white; transform: rotateY(180deg); border: 4px solid #38C0FF; color: #1e293b; padding: 10px; text-align: center; line-height: 1.2; }
        .card-back { background: #38C0FF; border: 4px solid white; color: white; font-size: 2.5rem; font-weight: bold; }

        #gallery { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 1.25rem; 
            padding: 1.5rem; 
            overflow-y: auto; 
            max-height: 75vh; 
            width: 100%;
        }
        .level-node { 
            background: rgba(255, 255, 255, 0.9); 
            backdrop-filter: blur(10px);
            border-radius: 2rem; 
            padding: 1.5rem 1rem; 
            text-align: center; 
            position: relative; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.1); 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid transparent;
        }
        .level-node:active { transform: scale(0.95); border-color: #38C0FF; }
        
        .modal { display: none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.6); z-index: 100; align-items: center; justify-content: center; backdrop-filter: blur(8px); padding: 20px; }
        .modal.active { display: flex; animation: fadeIn 0.3s ease-out; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        /* --- CSS çµæŸ --- */
    </style>
</head>
<body class="h-screen flex flex-col items-center">

    <div class="w-full max-w-md flex justify-between items-center p-4 z-10">
        <div id="sync-status" class="bg-white/90 backdrop-blur px-4 py-2 rounded-full flex items-center gap-2 shadow-sm transition-opacity duration-300 opacity-0">
            <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
            <span id="sync-text" class="text-xs font-bold text-slate-600 italic">å·²åŒæ­¥</span>
        </div>
        <button id="logout-btn" class="bg-white/90 backdrop-blur p-2 rounded-full shadow-lg active:scale-90 transition-transform">
            <img src="https://raw.githubusercontent.com/shuqikhor/pixel-icons/92a2d8ff3e9149b87404ec099a27fb90d7399bb9/icons/arrow-left.svg" class="w-6 h-6">
        </button>
    </div>

    <div id="map-view" class="w-full max-w-md flex-1 flex flex-col items-center">
        <h1 class="pixel-font text-3xl text-white my-6 drop-shadow-[0_4px_4px_rgba(0,0,0,0.25)]">åœ–æ–‡é…å°å¤§æŒ‘æˆ°</h1>
        <div id="gallery" class="px-6"></div>
    </div>

    <div id="game-view" class="hidden fixed inset-0 bg-[#38C0FF] z-50 flex flex-col items-center">
        <div class="w-full max-w-md p-6 flex justify-between items-center">
            <button onclick="backToMap()" class="bg-white/20 px-4 py-2 rounded-full text-white font-bold backdrop-blur">â¬… è¿”å›</button>
            <div class="bg-white/20 px-6 py-2 rounded-full text-white pixel-font text-2xl backdrop-blur shadow-inner">
                <span id="timer">00:00</span>
            </div>
        </div>
        <div id="game-grid" class="grid grid-cols-3 gap-3 p-4 w-full max-w-md flex-1 content-center"></div>
    </div>

    <div id="user-modal" class="modal">
        <div class="bg-white rounded-[2.5rem] p-10 w-full max-w-xs text-center shadow-2xl">
            <h2 class="pixel-font text-2xl mb-8 text-slate-700">å†’éšªè€…æ˜¯èª°ï¼Ÿ</h2>
            <input id="username-input" type="text" placeholder="è¼¸å…¥åå­—" class="w-full p-4 bg-slate-50 border-2 border-slate-100 rounded-2xl mb-8 outline-none focus:border-sky-400 transition-all text-center font-bold text-lg text-slate-700">
            <button id="confirm-user" class="w-full bg-sky-500 text-white py-4 rounded-2xl font-bold text-xl shadow-[0_8px_0_#0369a1] active:shadow-none active:translate-y-2 transition-all">é–‹å§‹æŒ‘æˆ°</button>
        </div>
    </div>

    <div id="result-modal" class="modal">
        <div class="bg-white rounded-[2.5rem] p-10 w-full max-w-xs text-center shadow-2xl border-4 border-yellow-200">
            <div id="result-stars" class="text-5xl mb-6"></div>
            <h2 id="result-title" class="pixel-font text-3xl text-slate-700 mb-2 italic">å¤ªç²¾å½©äº†ï¼</h2>
            <p id="result-time" class="text-slate-400 font-bold mb-8 text-lg"></p>
            <button onclick="backToMap()" class="w-full bg-sky-500 text-white py-5 rounded-2xl font-bold text-2xl shadow-[0_8px_0_#0369a1] active:shadow-none active:translate-y-2 transition-all">ä¸‹ä¸€é—œ</button>
        </div>
    </div>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbxcN6vSqaukUo0q0LL-iUL2kNClC6J9A8P66JEf4T3KK4Y7PaBUP893SCk7AWE_hKlM/exec"; 
        const levels = [
            { id: 1, title: 'ç¬¬ä¸€é—œï¼šæ°´æœ', items: [
                { word: 'ç´…è˜‹æœ', img: 'ğŸ' }, { word: 'é»ƒé¦™è•‰', img: 'ğŸŒ' }, { word: 'ç¶ è‘¡è„', img: 'ğŸ‡' }
            ]},
            { id: 2, title: 'ç¬¬äºŒé—œï¼šå‹•ç‰©', items: [
                { word: 'å°è²“å’ª', img: 'ğŸ±' }, { word: 'å°ç°ç‹—', img: 'ğŸ¶' }, { word: 'å°é›æ’', img: 'ğŸ¥' }
            ]}
        ];

        let currentLevel = null, flippedCards = [], matchedPairs = 0, startTime = null, timerInterval = null;
        const syncStatus = document.getElementById('sync-status'), syncText = document.getElementById('sync-text');

        // --- æ ¸å¿ƒé‚è¼¯ ---

        async function initApp() {
            // è‡ªå‹•æŠ“å– index.html å­˜ä¸‹çš„åå­—
            const user = localStorage.getItem('match_username');
            if (!user) {
                document.getElementById('user-modal').classList.add('active');
                return;
            }
            document.getElementById('user-modal').classList.remove('active');
            await fetchRecords(user); 
            showGallery();
        }

        async function fetchRecords(name) {
            syncStatus.style.opacity = '1'; syncText.innerText = 'åŒæ­¥ç´€éŒ„...';
            try {
                const res = await fetch(`${GAS_URL}?name=${encodeURIComponent(name)}`);
                const data = await res.json();
                levels.forEach(l => {
                    localStorage.removeItem(`best_${l.id}`);
                    localStorage.removeItem(`best_stars_${l.id}`);
                });
                Object.keys(data).forEach(id => {
                    localStorage.setItem(`best_${id}`, data[id].time);
                    localStorage.setItem(`best_stars_${id}`, data[id].stars);
                });
                syncText.innerText = 'å·²åŒæ­¥';
            } catch (e) { syncText.innerText = 'é›¢ç·šæ¨¡å¼'; }
            setTimeout(() => syncStatus.style.opacity = '0', 1000);
        }

        async function winGame() {
            clearInterval(timerInterval);
            const duration = Math.floor((new Date() - startTime) / 1000);
            const stars = duration < 12 ? 3 : (duration < 25 ? 2 : 1);
            const timeStr = document.getElementById('timer').innerText;

            // æœ¬åœ°å­˜å„²
            localStorage.setItem(`best_${currentLevel.id}`, timeStr);
            localStorage.setItem(`best_stars_${currentLevel.id}`, stars);

            // é›²ç«¯ä¸Šå‚³ (åŠ ä¸Š appType: "MATCHING")
            syncStatus.style.opacity = '1'; syncText.innerText = 'ä¸Šå‚³æˆç¸¾...';
            try {
                await fetch(GAS_URL, { 
                    method: 'POST', mode: 'no-cors', 
                    body: JSON.stringify({ 
                        appType: "MATCHING",
                        name: localStorage.getItem('match_username'), 
                        level: currentLevel.id, 
                        time: timeStr, 
                        stars: stars 
                    }) 
                });
                syncText.innerText = 'å·²ä¸Šå‚³';
            } catch (e) { syncText.innerText = 'ä¸Šå‚³å¤±æ•—'; }

            document.getElementById('result-stars').innerHTML = 'â­'.repeat(stars);
            document.getElementById('result-time').innerText = `â± ${timeStr}`;
            document.getElementById('result-modal').classList.add('active');
            setTimeout(() => syncStatus.style.opacity = '0', 1500);
        }

        function showGallery() {
            const gallery = document.getElementById('gallery');
            gallery.innerHTML = '';
            levels.forEach(l => {
                const s = parseInt(localStorage.getItem(`best_stars_${l.id}`)) || 0;
                const t = localStorage.getItem(`best_${l.id}`) || '--:--';
                const div = document.createElement('div');
                div.className = 'level-node';
                div.innerHTML = `
                    <div class="text-xs font-black text-sky-400 mb-1">LEVEL ${l.id}</div>
                    <div class="text-lg font-bold text-slate-700 mb-2">${l.title}</div>
                    <div class="text-yellow-400 mb-1 text-xl">${'â­'.repeat(s)}${'â˜†'.repeat(3-s)}</div>
                    <div class="text-xs text-slate-300 font-mono">${t}</div>
                `;
                div.onclick = () => startLevel(l);
                gallery.appendChild(div);
            });
        }

        function startLevel(l) {
            currentLevel = l; matchedPairs = 0; flippedCards = [];
            document.getElementById('map-view').classList.add('hidden');
            document.getElementById('game-view').classList.remove('hidden');
            
            let cards = [];
            l.items.forEach(i => {
                cards.push({ v: i.img, m: i.word });
                cards.push({ v: i.word, m: i.img });
            });
            cards.sort(() => Math.random() - 0.5);

            const grid = document.getElementById('game-grid');
            grid.innerHTML = '';
            cards.forEach(c => {
                const card = document.createElement('div');
                card.className = 'card aspect-square';
                card.innerHTML = `
                    <div class="card-inner">
                        <div class="card-front pixel-font text-2xl">${c.v}</div>
                        <div class="card-back">?</div>
                    </div>`;
                card.onclick = () => {
                    if (flippedCards.length < 2 && !card.classList.contains('flipped')) {
                        card.classList.add('flipped');
                        flippedCards.push({el: card, data: c});
                        if (flippedCards.length === 2) checkMatch();
                    }
                };
                grid.appendChild(card);
            });
            startTimer();
        }

        function checkMatch() {
            const [a, b] = flippedCards;
            if (a.data.v === b.data.m) {
                setTimeout(() => {
                    a.el.classList.add('matched'); b.el.classList.add('matched');
                    matchedPairs++;
                    if (matchedPairs === currentLevel.items.length) winGame();
                }, 500);
                flippedCards = [];
            } else {
                setTimeout(() => {
                    a.el.classList.remove('flipped'); b.el.classList.remove('flipped');
                    flippedCards = [];
                }, 1000);
            }
        }

        function startTimer() {
            startTime = new Date();
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                const diff = Math.floor((new Date() - startTime) / 1000);
                const m = Math.floor(diff/60).toString().padStart(2,'0'), s = (diff%60).toString().padStart(2,'0');
                document.getElementById('timer').innerText = `${m}:${s}`;
            }, 1000);
        }

        function backToMap() {
            document.getElementById('game-view').classList.add('hidden');
            document.getElementById('result-modal').classList.remove('active');
            document.getElementById('map-view').classList.remove('hidden');
            showGallery();
        }

        document.getElementById('confirm-user').onclick = () => {
            const val = document.getElementById('username-input').value.trim();
            if (val) { localStorage.setItem('match_username', val); initApp(); }
        };

        document.getElementById('logout-btn').onclick = () => { if(confirm("è¿”å›é¸å–®ï¼Ÿ")) window.location.href = "index.html"; };
        
        window.onload = initApp;
    </script>
</body>
</html>

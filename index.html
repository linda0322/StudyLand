<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的島嶼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @font-face {
            font-family: 'Cubic11';
            src: url('https://cdn.jsdelivr.net/gh/ACh-K/Cubic-11@90bc0e197c4db0fc8c75fe30c2d82dea03da707e/fonts/ttf/Cubic_11.ttf') format('truetype');
        }
        body { font-family: 'Cubic11', sans-serif; background: #87CEEB; margin: 0; overflow: hidden; }
        
        /* 島嶼背景圖層 */
        #island-map {
            width: 2000px; height: 2000px; /* 大地圖 */
            background-image: url('https://raw.githubusercontent.com/linda0322/StudyLand/refs/heads/main/image/Sky.png'); /* 這裡換成你的島嶼底圖 */
            background-size: cover;
            position: relative;
        }

        .draggable {
            position: absolute;
            cursor: move;
            width: 80px; height: 80px;
            z-index: 10;
            touch-action: none; /* 防止手機瀏覽器干擾 */
        }
        .draggable img { width: 100%; pointer-events: none; }

        .ui-overlay {
            position: fixed; top: 20px; left: 20px; z-index: 100;
            background: rgba(255,255,255,0.8); padding: 10px 20px;
            border-radius: 20px; backdrop-filter: blur(5px);
        }
        #save-btn {
            position: fixed; bottom: 30px; right: 30px; z-index: 100;
            background: #38C0FF; color: white; padding: 15px 30px;
            border-radius: 50px; cursor: pointer; border: none;
            box-shadow: 0 4px 15px rgba(56, 192, 255, 0.4);
        }
        #save-btn:active { transform: scale(0.95); }
    </style>
</head>
<body>

<div class="ui-overlay shadow-lg">
    探險家: <span id="display-username">...</span>
    <button onclick="location.href='index.html'" class="ml-4 text-slate-500 text-xs">返回</button>
</div>

<button id="save-btn" onclick="saveData()">儲存我的島嶼</button>

<div id="island-map">
    <div class="draggable" id="obj_house" style="left: 200px; top: 300px;">
        <img src="https://raw.githubusercontent.com/linda0322/StudyLand/refs/heads/main/image/NPC_Icon.png">
    </div>
    <div class="draggable" id="obj_tree" style="left: 400px; top: 200px;">
        <img src="https://cdn-icons-png.flaticon.com/512/489/489969.png">
    </div>
</div>

<script>
    const SCRIPT_URL = '你的_GAS_網址';
    const username = localStorage.getItem('studyLandUser');

    async function initApp() {
        if (!username) { window.location.href = 'index.html'; return; }
        document.getElementById('display-username').innerText = username;

        // 1. 從 GAS 載入位置
        try {
            const response = await fetch(`${SCRIPT_URL}?user=${encodeURIComponent(username)}`);
            const data = await response.json();
            if (data && data.length > 0) {
                data.forEach(item => {
                    const el = document.getElementById(item.id);
                    if (el) {
                        el.style.left = item.left;
                        el.style.top = item.top;
                    }
                });
            }
        } catch (e) { console.error("載入失敗:", e); }

        bindDraggable();
    }

    function bindDraggable() {
        const draggables = document.querySelectorAll('.draggable');
        draggables.forEach(el => {
            el.onmousedown = function(e) {
                let shiftX = e.clientX - el.getBoundingClientRect().left;
                let shiftY = e.clientY - el.getBoundingClientRect().top;

                document.onmousemove = function(e) {
                    el.style.left = e.pageX - shiftX + 'px';
                    el.style.top = e.pageY - shiftY + 'px';
                };

                document.onmouseup = function() {
                    document.onmousemove = null;
                };
            };
            el.ondragstart = () => false;
        });
    }

    async function saveData() {
        const btn = document.getElementById('save-btn');
        btn.innerText = "儲存中...";
        
        const items = document.querySelectorAll('.draggable');
        const positions = Array.from(items).map(el => ({
            id: el.id,
            left: el.style.left,
            top: el.style.top
        }));

        try {
            // 使用 POST 傳送資料
            await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors', // 解決跨網域問題
                body: JSON.stringify({ user: username, positions: positions })
            });
            alert('島嶼已儲存！');
        } catch (e) {
            console.error(e);
            alert('儲存發生錯誤');
        } finally {
            btn.innerText = "儲存我的島嶼";
        }
    }

    window.onload = initApp;
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æˆ‘çš„å³¶å¶¼</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/svg" href="https://lh3.googleusercontent.com/d/1x9g9cC2Z3YOQXjplPElgLOtBuKixb6lD">
    <link rel="apple-touch-icon" href="https://lh3.googleusercontent.com/d/1UL5PytrCRj0UFA9yJ2QFKowmTmBw-rZn">
    <link rel="stylesheet" href="../../style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* =========================================
           ğŸï¸ æ•´é«”ç‰ˆé¢ Overall
           ========================================= */
        body {height: 100dvh; width: 100vw;
              position: fixed;
              overflow: hidden;
              margin: 0; padding: 0; 
              overscroll-behavior: none; -webkit-user-select: none; touch-action: none;
              display: flex; align-items: center; justify-content: center;
              font-family: 'Noto Sans TC', sans-serif; background-color: #1a1a1a;            
              cursor: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='50' height='50' style='font-size:36px'><text x='50%' y='50%' dominant-baseline='central' text-anchor='middle'>â˜ï¸</text></svg>") 25 25, auto;
        }
            /* ğŸ“² æ‰‹æ©Ÿæ—‹è½‰æç¤º Orientation Noti */
            #orientation-noti-landscape {
              display: none;
              position: fixed;
              inset: 0;
              z-index: 99999;
              background-color: #1dc5fd;
              flex-direction: column; align-items: center; justify-content: center;}
            @media screen and (max-width: 700px) and (orientation: portrait) {
              #orientation-noti-landscape {display: flex !important;} #game-stage {display: none;}}
            @keyframes phone-landscape {
              0% {transform: rotate(0deg);} 
              30% {transform: rotate(-90deg);} 
              70% {transform: rotate(-90deg);} 
              100% {transform: rotate(0deg);}}
            .animate-phone-landscape {animation: phone-landscape 3s ease-in-out infinite; transform-origin: center;}

    
       /* =========================================
          ğŸ”˜ æŒ‰éˆ•è£œå…… Button
          ========================================= */   
        button {transition: transform 0.1s ease;}
        .draggable, .inventory-item {cursor: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='55' height='55' style='font-size:40px; opacity:0.8'><text x='50%' y='50%' dominant-baseline='central' text-anchor='middle'>ğŸŒ¥ï¸</text></svg>") 27 27, pointer !important;}
        .fixed-controls-left {position: absolute !important; top: 10px; left: 10px; z-index: 100; display: flex; gap: 8px;}
        .fixed-controls-right {position: absolute !important; top: 10px; right: 10px; z-index: 100; display: flex; gap: 8px;}
        .fixed-controls-left button:hover, .fixed-controls-right button:hover, #orientation-noti-landscape button:hover {background-color: rgba(255, 255, 255, 0.2); color: rgba(255, 255, 255, 1);}
        .fixed-controls-left button:hover svg, .fixed-controls-right button:hover svg, .fixed-controls-left button:active svg, .fixed-controls-right button:active svg {stroke: white !important;}
        .fixed-controls-left button:active, .fixed-controls-right button:active, #orientation-noti-landscape button:active {background-color: rgba(255, 255, 255, 0.3); color: rgba(255, 255, 255, 1); transform: scale(0.95);}
        @media screen and (max-width: 932px) {.fixed-controls-left, .fixed-controls-right {gap: 8px; top: 15px;}
                                              .fixed-controls-left button, .fixed-controls-right button {background: rgba(255, 255, 255, 0.9); padding: 12px;}
                                              .fixed-controls-left svg, .fixed-controls-right svg {width: 26px !important; height: 26px !important;}
                                              button[onclick*="toggle"] svg.lucide-x {width: 32px !important; height: 32px !important;}}
      
      /* =========================================
         ğŸ–¼ï¸ 16:9 å¤–æ¡† Frame
         ========================================= */   
        #game-stage {position: relative; width: 1280px; height: 720px; overflow: hidden; flex-shrink: 0; 
                     background-color: #333;
                     transition: transform 0.2s ease; transform-origin: center center;}
        #background-img {z-index: 0 !important;
                         width: 100.2%; height: 100.2%;
                         object-fit: cover; position:
                         absolute; top: 50%; left: 50%;
                         -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; -webkit-user-drag: none; pointer-events: none;
                         transform: translate(-50%, -50%);}

       /* =========================================
          ğŸ§¸ ç‰©ä»¶ Items
          ========================================= */         
         
         #items-layer {position: absolute; inset: 0; z-index: 10; pointer-events: none;}
         .draggable {position: absolute; z-index: 10;
                     cursor: move; pointer-events: auto; touch-action: none; -webkit-touch-callout: none; -webkit-user-drag: none; -webkit-user-select: none; -ms-user-select: none; -moz-user-select: none;
                     display: flex; align-items: center; justify-content: center;}
         .draggable img {width: 100%; height: auto; display: block;
                         pointer-events: none; -webkit-touch-callout: none; user-select: none; -webkit-user-select: none; -webkit-user-drag: none;}
         
         /* ğŸ  å€‰åº« Storage */
         #storage-modal {overscroll-behavior: none;}
         .tab-active {background: #38C0FF !important; color: white !important;}
         .tab-btn:hover {z-index: 10; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); transform: scale(0.95);}
         .tab-active:hover {transform: scale(0.95);}
         #storage-items {touch-action: pan-y; overscroll-behavior: contain; min-height: 300px;}
         .inventory-item {transition: all 0.2s; cursor: pointer;}
         .inventory-item:hover {background: rgba(255,255,255,0.9); transform: scale(1.05);}
         @media screen and (max-width: 932px) {#storage-items {grid-template-columns: repeat(3, 1fr); gap: 12px;}
                                               .tab-btn {min-width: 80px; font-size: 15px; padding: 10px 20px;}
                                               .inventory-item {border-radius: 20px; padding: 15px 10px;}
                                               .inventory-item img {width: 70px; height: 70px;}
                                               .inventory-item span {font-size: 12px;}}
         /* ğŸï¸ å³¶å¶¼ Island */
         #island-buttons-container a, #island-buttons-container img {-webkit-user-drag: none; -moz-user-drag: none; -o-user-drag: none; user-drag: none; touch-action: none; -webkit-touch-callout: none;}
         @media screen and (max-width: 932px) {#island-title {font-size: 18px; margin-left: 2px;}
                                               button[onclick="toggleIslandMenu()"] {height: 50px; padding-left: 16px; padding-right: 16px;}}
    </style>
</head>

<body>
    <!-- ğŸ“² æ‰‹æ©Ÿæ—‹è½‰æç¤º Orientation Noti -->
    <div id="orientation-noti-landscape">
        <button onclick="location.href='../../index.html'" class="z-[10000] absolute top-5 left-6 normal-button no-touch" title="è¿”å›ä¸»é ">
            <svg class="normal-button-svg" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
        </button>
        <div class="animate-phone-landscape w-20 h-20 flex items-center justify-center mb-6">
            <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="20" x="5" y="2" rx="2" ry="2"/><path d="M12 18h.01"/></svg>
        </div>
        <h2 class="font-cubic text-white text-xl thick-border tracking-wider">æ—‹è½‰è¢å¹•ä»¥é€²å…¥å³¶å¶¼</h2>
    </div>

    <!-- ğŸšª å€‰åº« Storage -->
    <div id="storage-modal" class="hidden fixed z-[3000] inset-0 bg-black/20 backdrop-blur-sm flex items-center justify-center p-4 transition-opacity duration-300 ease-in-out">
        <div class="w-[80%] max-w-lg h-[500px] glass-panel rounded-[30px] border-white/50 shadow-2xl flex flex-col relative p-8">
            <button onclick="toggleStorage()" class="absolute top-5 right-6 text-slate-400 hover:text-slate-600 hover:scale-110 active:scale-95 transition-all"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x-icon lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg></button>
            <h2 class="font-cubic text-slate-600 text-xl thick-border text-center tracking-wider mb-6">å€‰åº«</h2>
            <div id="storage-tabs" class="no-scrollbar overflow-x-auto flex gap-2 mb-4 mt-4 mx-2 pb-2 flex-shrink-0"></div>
            <div id="storage-items" class="flex-1 overflow-y-auto border-t border-slate-200 grid grid-cols-3 sm:grid-cols-4 gap-4 p-2 pt-4">
                <p class="col-span-full font-cubic text-slate-400 text-center py-10">æ­£åœ¨å°‹æ‰¾é‘°åŒ™...</p>
            </div>
        </div>
    </div>
        
    <!-- ğŸï¸ å³¶å¶¼ Island -->
    <div id="island-menu" class="hidden fixed z-[2000] inset-0 bg-black/20 backdrop-blur-sm flex items-center justify-center transition-opacity duration-300 ease-in-out">
        <div class="w-[80%] max-w-lg glass-panel rounded-[30px] border-white/50 shadow-2xl relative p-8">
            <button onclick="toggleIslandMenu()" class="absolute top-6 right-8 text-slate-400 text-2xl hover:text-slate-600 hover:scale-110 active:scale-95 transition-all"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x-icon lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg></button>
            <h2 class="font-cubic text-slate-600 text-xl thick-border text-center tracking-wider mb-6">æƒ³å»å“ªè£¡ï¼Ÿ</h2>
            <div id="island-buttons-container" class="w-full grid grid-cols-3 gap-6">
                <div class="w-full col-span-3 flex flex-col items-center justify-center py-12 gap-4"><span class="text-5xl">ğŸ—ºï¸</span>
                    <p class="w-full font-cubic text-slate-400 thin-border tracking-wider flex col-span-full justify-center text-center items-center py-8">æ­£åœ¨æ‰“é–‹åœ°åœ–</p>
                </div>
            </div>
        </div>
    </div>

    <!-- âœ… ç¢ºèªè¦–çª— Confirm Modal -->
    <div id="confirm-modal" class="hidden fixed z-[10000] inset-0 bg-black/20 backdrop-blur-sm flex justify-center items-center p-6">
        <div class="w-full max-w-xs glass-panel rounded-[40px] shadow-2xl flex flex-col text-center items-center p-8">
            <h2 id="confirm-title" class="font-cubic text-slate-700 text-xl thick-border tracking-wider mb-4">ç¢ºå®šè¦å„²å­˜å—ï¼Ÿ</h2>
            <div class="w-full flex gap-4">
                <button onclick="closeConfirm()" class="no-touch flex-1 bg-slate-50 rounded-2xl font-cubic text-slate-600 thin-border py-3 hover:bg-slate-100 active:bg-slate-100 active:scale-95 transition-all">å–æ¶ˆ</button>
                <button id="confirm-button" class="no-touch flex-1 bg-[#38C0FF] rounded-2xl font-cubic text-white thin-border py-3 hover:bg-[#2da9e6] active:bg-[#2da9e6] active:scale-95 transition-all">ç¢ºå®š</button>
            </div>
        </div>
    </div>
    
    <!-- ğŸ–¼ï¸ 16:9 å¤–æ¡† Frame -->
    <div id="game-stage">
      
      <nav>
        <!-- â¬…ï¸ å·¦é‚Š Left -->
        <div class="fixed-controls-left">
          <!-- ğŸ  ä¸»é  Home -->
          <button onclick="handleHome()" class="normal-button no-touch" title="è¿”å›ä¸»é ">
            <svg xmlns="http://www.w3.org/2000/svg" class="normal-button-svg lucide lucide-door-open-icon lucide-door-open" viewBox="0 0 24 24"><path d="M11 20H2"/><path d="M11 4.562v16.157a1 1 0 0 0 1.242.97L19 20V5.562a2 2 0 0 0-1.515-1.94l-4-1A2 2 0 0 0 11 4.561z"/><path d="M11 4H8a2 2 0 0 0-2 2v14"/><path d="M14 12h.01"/><path d="M22 20h-3"/></svg>
          </button>
          <!-- ğŸï¸ å³¶å¶¼ Island -->
          <button onclick="toggleIslandMenu()" class="group glass-panel rounded-full shadow-md text-slate-500 flex items-center px-4 py-2 gap-3" title="åœ°é»">
            <svg xmlns="http://www.w3.org/2000/svg" class="normal-button-svg lucide lucide-map-pinned-icon lucide-map-pinned group-hover:text-white transition-colors" viewBox="0 0 24 24"><path d="M18 8c0 3.613-3.869 7.429-5.393 8.795a1 1 0 0 1-1.214 0C9.87 15.429 6 11.613 6 8a6 6 0 0 1 12 0"/><circle cx="12" cy="8" r="2"/><path d="M8.714 14h-3.71a1 1 0 0 0-.948.683l-2.004 6A1 1 0 0 0 3 22h18a1 1 0 0 0 .948-1.316l-2-6a1 1 0 0 0-.949-.684h-3.712"/></svg> 
            <span id="island-title" class="font-cubic text-[13px] text-slate-500 thin-border text-center tracking-wider translate-y-[1px] group-hover:text-white transition-colors">å°‡æŠµé”...</span>
          </button>
          <!-- ğŸ¤– NPC Island -->
          <button onclick="handleNPC()" class="normal-button no-touch" title="NPCçš„å³¶å¶¼">
            <svg xmlns="http://www.w3.org/2000/svg" class="normal-button-svg lucide lucide-bot-icon lucide-bot" viewBox="0 0 24 24"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg>
          </button>
          <!-- ğŸšª å€‰åº«æŒ‰éˆ• Storage -->
          <button onclick="toggleStorage()" class="normal-button no-touch" title="å€‰åº«">
            <svg xmlns="http://www.w3.org/2000/svg" class="normal-button-svg lucide lucide-warehouse-icon lucide-warehouse" viewBox="0 0 24 24"><path d="M18 21V10a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1v11"/><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V8a2 2 0 0 1 1.132-1.803l7.95-3.974a2 2 0 0 1 1.837 0l7.948 3.974A2 2 0 0 1 22 8z"/><path d="M6 13h12"/><path d="M6 17h12"/></svg>
          </button>
        </div>
        <!-- â¡ï¸ å³é‚Š Right -->
        <div class="fixed-controls-right">
          <!-- ğŸ’¾ å„²å­˜ Save -->
          <button id="save-button" onclick="handleSave()" class="normal-button no-touch" title="å„²å­˜">
            <svg xmlns="http://www.w3.org/2000/svg" class="normal-button-svg lucide lucide-save-icon lucide-save" viewBox="0 0 24 24"><path d="M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"/><path d="M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7"/><path d="M7 3v4a1 1 0 0 0 1 1h7"/></svg>
          </button>
          <!-- ğŸ‘€ æª¢è¦– Preview -->
          <button id="preview-button" onclick="handlePreview()" class="glass-panel rounded-full text-sky-700 shadow-md p-2" title="é è¦½æ¨¡å¼">
            <svg xmlns="http://www.w3.org/2000/svg" class="normal-button-svg lucide lucide-eye-icon lucide-eye" viewBox="0 0 24 24"><path d="M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0"/><circle cx="12" cy="12" r="3"/></svg>
          </button>
          <!-- ğŸ”„ é‡æ–°æ•´ç† Refresh -->
          <button id="reload-button" onclick="handleReload()" class="glass-panel rounded-full text-sky-700 shadow-md p-2" title="é‡æ–°æ•´ç†">
            <svg class="normal-button-svg" viewBox="0 0 24 24"><path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
          </button>  
        </div>
      </nav>
      
      <!-- ğŸï¸ å³¶å¶¼èƒŒæ™¯ Island Background -->
        <div id="background-layer"><img id="background-img" src="" alt="èƒŒæ™¯" class="pointer-events-none;"></div>
      
      <!-- ğŸ§¸ ç‰©ä»¶ Items -->
      <div id="items-layer"></div>
      
   </div>

    <!-- ğŸ é€šçŸ¥ Toast -->
    <div id="toast" class="pointer-events-none fixed z-[9999] top-12 left-1/2 -translate-x-1/2 glass-panel rounded-2xl shadow-2xl flex items-center gap-3 px-6 py-3 opacity-0 -translate-y-4 transition-all duration-500">
        <div id="toast-icon" class="text-xl"></div><span id="toast-msg" class="font-cubic text-slate-600 thin-border tracking-wider"></span>
    </div>

<script src="../../common.js"></script>
<script>
    // =========================================
    // ğŸŒ GAS
    // =========================================
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxUqJxvUn_seiDHWNYfbKZVKYVFqNEov1wmDTiMYUupFrmVURQUFp-nbujh3YhCXlNF/exec'; 
        
        const username = localStorage.getItem('userID');
        const urlParams = new URLSearchParams(window.location.search);
        const currentIslandId = urlParams.get('id') || 'island_1';
        let assetLibrary = {};
        let userInventory = []; 

        // âœï¸ğŸï¸ å³¶å¶¼èƒŒæ™¯ ISLAND BACKGROUND
        const islandConfig = {'island_1': { name: 'è‰åœ°', bg: 'https://lh3.googleusercontent.com/d/1j_GFfezO8NNHnF1M-q7euOdDHOdtP8vF', color: 'bg-lime-200', icon: 'ğŸŒ³' },
                              'island_2': { name: 'æµ·æ´‹', bg: 'https://lh3.googleusercontent.com/d/1Roy33fghpQHRS1IZk2N_MxYbY1-YKVRu', color: 'bg-sky-200', icon: 'ğŸŒŠ' },
                              'island_3': { name: 'æ²™æ¼ ', bg: 'https://lh3.googleusercontent.com/d/15OIBcHpnpYkV1hH4pk64qJjEon-y1plq', color: 'bg-amber-200', icon: 'ğŸœï¸' },
                             };
            
        // âœ… åŠ è¼‰ LOADING INFO
        async function initApp() {if (!username) {window.location.href = '../../index.html'; return;}
                                  const startTime = Date.now();
                                  toggleLoading(true, "é£›è¡Œä¸­", "â˜ï¸");
                                  const config = islandConfig[currentIslandId] || islandConfig['island_1'];
                                  document.getElementById('background-img').src = config.bg; 
                                  document.getElementById('island-title').innerText = config.name;
                                  try {const [libResp, posResp] = await Promise.all([fetch(`${SCRIPT_URL}?action=getLibrary`), fetch(`${SCRIPT_URL}?user=${encodeURIComponent(username)}&islandId=${currentIslandId}&action=getPositions`)]);
                                       assetLibrary = await libResp.json();
                                       const savedItems = await posResp.json(); const itemsLayer = document.getElementById('items-layer');
                                       itemsLayer.innerHTML = '';
                                       if (Array.isArray(savedItems)) {savedItems.forEach(item => {const parts = item.id.split('_'); parts.shift(); parts.pop(); const assetType = parts.join('_');
                                                                                                   console.log("æ­£åœ¨è¼‰å…¥ç‰©ä»¶:", assetType);
                                                                                                   if (assetLibrary[assetType]) {createDraggableElement(item.id, assetType, item.leftPercent, item.topPercent);}
                                                                                                   else {console.error("æ‰¾ä¸åˆ°è³‡ç”¢å®šç¾©:", assetType, "ã€‚è«‹æª¢æŸ¥ Asset_Library çš„åç¨±æ˜¯å¦ä¸€è‡´ã€‚");}});}
                                       await loadIslandList(); await refreshInventory();} 
                                  catch (err) {console.error("è¼‰å…¥å¤±æ•—:", err); showToast("è«‹æª¢æŸ¥ç¶²è·¯", "error");} 
                                  finally {const elapsedTime = Date.now() - startTime; 
                                           const minimumWait = 1000; 
                                           const remainingWait = Math.max(0, minimumWait - elapsedTime);
                                           setTimeout(() => {toggleLoading(false);}, remainingWait);}}
        
        // ğŸ¤ŸğŸ» åŠŸèƒ½ FUNCTIONï¼šğŸ‘†ğŸ» è£½é€ æ‹–æ›³ç‰©ä»¶ CREATE DRAGGABLE ITEMS
        function createDraggableElement(id, type, left = 50, top = 50) {const config = assetLibrary[type]; const div = document.createElement('div');
                                                                        console.log(`æ­£åœ¨éƒ¨ç½² ${type}, è¨­å®šå¯¬åº¦ç‚º: ${config.width}`);
                                                                        div.className = 'draggable'; div.id = id;
                                                                        if (config && config.width) {let widthStr = String(config.width); if (widthStr.includes('%')) {
                                                                            const percentValue = parseFloat(widthStr) / 100;
                                                                            const actualPixelWidth = 1280 * percentValue; div.style.width = actualPixelWidth + 'px';
                                                                            console.log(`ç‰©ä»¶ ${type} å¯¬åº¦è¨ˆç®—ï¼š1280 * ${percentValue} = ${actualPixelWidth}px`);} else {div.style.width = widthStr.includes('px') ? widthStr : widthStr + 'px';}}
                                                                        else {div.style.width = '150px';} div.style.left = left + '%'; div.style.top = top + '%'; div.style.transform = 'translate(-50%, -50%)';
                                                                        const isBottom = String(config.isBottom).toLowerCase() === 'true'; div.style.zIndex = isBottom ? "1" : "10";
                                                                        if (isBottom) div.dataset.isBottom = "true";
                                                                        div.innerHTML = `<img src="${config.imgURL}">`; div.oncontextmenu = (e) => {e.preventDefault(); handleItemReturn(div);};
                                                                        document.getElementById('items-layer').appendChild(div); bindDraggable(div);}
        
        // ğŸ¤ŸğŸ» åŠŸèƒ½ FUNCTIONï¼šğŸ‘†ğŸ» æ‹–æ›³ç‰©ä»¶ DRAG ITEMS
        function bindDraggable(el) {const stage = document.getElementById('game-stage'); let longPressTimer; let startX, startY; let isLongPress = false;
                                    el.onmousedown = el.ontouchstart = function(e) {if (e.button === 2) return; const isTouch = e.type === 'touchstart'; startX = isTouch ? e.touches[0].clientX : e.clientX; startY = isTouch ? e.touches[0].clientY : e.clientY; isLongPress = false;
                                                                                    longPressTimer = setTimeout(() => {isLongPress = true; handleItemReturn(el);}, 1000);
                                                                                    if (el.dataset.isBottom !== "true") {document.querySelectorAll('.draggable:not([data-is-bottom="true"])').forEach(d => d.style.zIndex = "10"); el.style.zIndex = "100";}
                                                                                    const stageRect = stage.getBoundingClientRect(); const scale = stageRect.width / 1280; const itemRect = el.getBoundingClientRect();
                                                                                    const shiftX = (startX - itemRect.left) / scale; const shiftY = (startY - itemRect.top) / scale;
                                                                                    function moveAt(currentClientX, currentClientY) {if (Math.abs(currentClientX - startX) > 10 || Math.abs(currentClientY - startY) > 10) {clearTimeout(longPressTimer);}
                                                                                                                                     if (isLongPress) return;
                                                                                                                                     let mouseXOnStage = (currentClientX - stageRect.left) / scale;
                                                                                                                                     let mouseYOnStage = (currentClientY - stageRect.top) / scale;
                                                                                                                                     let newPercentL = (mouseXOnStage - shiftX + (el.offsetWidth / 2)) / stage.offsetWidth * 100;
                                                                                                                                     let newPercentT = (mouseYOnStage - shiftY + (el.offsetHeight / 2)) / stage.offsetHeight * 100;
                                                                                                                                     newPercentL = Math.max(0, Math.min(newPercentL, 100)); newPercentT = Math.max(0, Math.min(newPercentT, 100));
                                                                                                                                     el.style.left = newPercentL + '%'; el.style.top = newPercentT + '%';}
                                                                                    function onMouseMove(e) {const moveX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX; const moveY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY; moveAt(moveX, moveY);}
                                                                                    const onMouseUp = () => {clearTimeout(longPressTimer); 
                                                                                                             document.removeEventListener('mousemove', onMouseMove); document.removeEventListener('touchmove', onMouseMove); 
                                                                                                             document.removeEventListener('mouseup', onMouseUp); document.removeEventListener('touchend', onMouseUp);};
                                                                                    document.addEventListener('mousemove', onMouseMove); document.addEventListener('touchmove', onMouseMove, {passive: false}); 
                                                                                    document.addEventListener('mouseup', onMouseUp); document.addEventListener('touchend', onMouseUp);}; el.ondragstart = function() {return false;};}
        let currentReturningEl = null; function handleItemReturn(el) {if (!confirmModal.classList.contains('hidden')) return; currentReturningEl = el; openConfirm("è¦æ”¶å›å€‰åº«å—ï¼Ÿ", () => {
            const parts = currentReturningEl.id.split('_'); parts.shift(); parts.pop(); const type = parts.join('_'); const invIdx = userInventory.findIndex(i => i.assetType === type);
            if (invIdx > -1) {userInventory[invIdx].available++;}
            currentReturningEl.remove(); currentReturningEl = null; showToast("å·²æ”¶å›å€‰åº«");
            const activeTab = document.querySelector('.tab-active')?.innerText.trim() || 'å…¨éƒ¨'; renderInventoryItems(activeTab);});}

        // ğŸ  å€‰åº« STORAGE
        const storageModal = document.getElementById('storage-modal');
        function toggleStorage() {if (storageModal.classList.contains('hidden')) {storageModal.classList.remove('hidden'); if (userInventory.length === 0) {refreshInventory();} 
                                  else {const activeTab = document.querySelector('.tab-active')?.innerText.trim() || 'å…¨éƒ¨'; renderInventoryItems(activeTab);}} 
                                  else {storageModal.classList.add('hidden');}}
        storageModal.addEventListener('click', (e) => {if (e.target === storageModal) {storageModal.classList.add('hidden');}});
            // ğŸ”¢ åº«å­˜ INVENTORY
            async function refreshInventory() {const container = document.getElementById('storage-items');
                try {const resp = await fetch(`${SCRIPT_URL}?user=${encodeURIComponent(username)}&action=getInventory`); const serverInventory = await resp.json();
                     const islandIds = ['island_1', 'island_2', 'island_3']; const allPositionsResponses = await Promise.all(islandIds.map(id => fetch(`${SCRIPT_URL}?user=${encodeURIComponent(username)}&islandId=${id}&action=getPositions`).then(r => r.json())));
                     const activeTypesAcrossIslands = new Set(); allPositionsResponses.forEach(savedItems => {if (Array.isArray(savedItems)) {savedItems.forEach(item => {const parts = item.id.split('_'); parts.shift(); parts.pop(); activeTypesAcrossIslands.add(parts.join('_'));});}});
                     const serverTypes = serverInventory.map(i => i.assetType); const combinedTypes = [...new Set([...serverTypes, ...Array.from(activeTypesAcrossIslands)])];
                     userInventory = combinedTypes.map(type => {const libraryInfo = assetLibrary[type]; if (!libraryInfo) return null; const invItem = serverInventory.find(i => i.assetType === type); 
                                                                return {assetType: type, imgURL: libraryInfo.imgURL, category: libraryInfo.category || 'å…¶ä»–', available: invItem ? invItem.available : 0};}).filter(item => item !== null);
                     const categories = ['å…¨éƒ¨', ...new Set(userInventory.map(i => i.category))]; const tabContainer = document.getElementById('storage-tabs');
                     tabContainer.innerHTML = categories.map(cat => `<button onclick="filterStorage('${cat}')" class="tab-btn whitespace-nowrap px-4 py-1 rounded-full bg-white text-sm font-cubic thin-border text-slate-500 transition-all">${cat}</button>`).join('');
                     renderInventoryItems('å…¨éƒ¨'); } catch (e) {console.error("è·¨å³¶æ›´æ–°å€‰åº«å¤±æ•—:", e); container.innerHTML = "è¼‰å…¥å¤±æ•—";}}
            // ğŸ¤ŸğŸ» åŠŸèƒ½ FUNCTIONï¼šğŸ¨ æ¸²æŸ“åº«å­˜ RENDER INVENTORY
            function renderInventoryItems(filter) {const container = document.getElementById('storage-items'); const items = filter === 'å…¨éƒ¨' ? userInventory : userInventory.filter(i => i.category === filter);
                                                   // âœï¸ğŸš« åº«å­˜ç©ºç™½ DESIGN
                                                   if (items.length === 0) {container.innerHTML = `<div class="w-full col-span-full flex flex-col items-center justify-center py-5 gap-4">
                                                                                                       <span class="text-5xl mb-2">ğŸ™‚â€â†”ï¸</span>
                                                                                                       <p class="w-full font-cubic text-slate-400 thin-border tracking-widest text-center">ä¸€ç„¡æ‰€æœ‰</p>
                                                                                                   </div>`; return;}
                                                   // âœï¸ğŸˆšï¸ åº«å­˜ç”¨ç›¡ DESIGN
                                                   container.innerHTML = items.map(item => {const isOutOfStock = item.available <= 0; const statusClass = isOutOfStock ? "pointer-events-none opacity-50 grayscale" : "active:scale-95";
                                                                                            const countColor = isOutOfStock ? "text-slate-300" : "text-slate-400";
                                                                                            return `<div onclick="${isOutOfStock ? '' : `deployFromStorage('${item.assetType}')`}"  class="inventory-item aspect-square glass-panel rounded-xl flex flex-col items-center justify-center gap-2 p-2 transition-all ${statusClass}">
                                                                                                        <img src="${item.imgURL}" class="pointer-events-none w-12 h-12 object-contain" draggable="false">
                                                                                                        <span class="font-cubic ${countColor} text-[16px] thin-border">${item.available}</span>
                                                                                                    </div>`;}).join('');}
            // ğŸ¤ŸğŸ» åŠŸèƒ½ FUNCTIONï¼šğŸ—‚ï¸ åˆ†é¡ CATEGORY
            function filterStorage(cat) {document.querySelectorAll('.tab-btn').forEach(btn => {btn.classList.toggle('tab-active', btn.innerText.trim() === cat);}); renderInventoryItems(cat);}                                                                                    
            // ğŸ¤ŸğŸ» åŠŸèƒ½ FUNCTIONï¼šğŸ‘†ğŸ» å¾åº«å­˜æ‹¿å‡ºç‰©ä»¶ TAKE ITEMS
            function deployFromStorage(type) {const invIdx = userInventory.findIndex(i => i.assetType === type); 
                                              if (invIdx > -1 && userInventory[invIdx].available > 0) {userInventory[invIdx].available--; 
                                                                                                       const existing = document.querySelectorAll(`[id^="item_${type}_"]`); let maxNum = 0; existing.forEach(el => {const num = parseInt(el.id.split('_').pop()); if (num > maxNum) maxNum = num;});
                                                                                                       const newId = `item_${type}_${maxNum + 1}`; createDraggableElement(newId, type, 50, 50); 
                                                                                                       const activeTab = document.querySelector('.tab-active')?.innerText.trim() || 'å…¨éƒ¨'; renderInventoryItems(activeTab); showToast("å·²æ”¾ç½®");} 
                                              else {showToast("åº«å­˜ä¸è¶³", "error");}}

        // ğŸï¸ å³¶å¶¼ ISLAND
        const islandMenu = document.getElementById('island-menu');
        function toggleIslandMenu() { islandMenu.classList.toggle('hidden'); }
        islandMenu.addEventListener('click', (e) => {if (e.target === islandMenu) {islandMenu.classList.add('hidden');}});
            // âœï¸ğŸï¸ å³¶å¶¼ MENU DESIGN
            async function loadIslandList() {try {const response = await fetch(`${SCRIPT_URL}?user=${encodeURIComponent(username)}&action=getIslands`);
                                                  const allowedIslands = await response.json(); const container = document.getElementById('island-buttons-container'); container.innerHTML = ''; 
                                                  if (allowedIslands.length === 0) {container.innerHTML = `
                                                  <div class="w-full col-span-3 flex flex-col items-center justify-center py-12 gap-4"><span class="text-5xl">ğŸï¸</span>
                                                      <p class="font-cubic text-slate-400 thin-border text-center tracking-widest">ç›®å‰ç„¡å³¶å¯æ­¸</p>
                                                  </div>`; return;}
                                                  allowedIslands.forEach(id => {const cfg = islandConfig[id] || { name: 'æœªçŸ¥å³¶å¶¼', color: 'bg-slate-100', icon: 'ğŸï¸' };
                                                                                const btnHtml = `
                                                                                <a href="island.html?id=${id}" class="select-none group bg-slate-50 rounded-[25px] text-center p-4 hover:bg-white hover:shadow-xl active:scale-95 transition-all" draggable="false">
                                                                                    <div class="select-none h-20 ${cfg.color} rounded-[20px] text-3xl flex items-center justify-center mb-2">${cfg.icon}</div>
                                                                                    <h3 class="select-none font-cubic text-slate-500 text-lg thin-border">${cfg.name}</h3>
                                                                                </a>`; container.innerHTML += btnHtml;});} catch (e) {console.error("è¼‰å…¥å¤±æ•—", e);}}
            async function loadIslandData() {try {const resp = await fetch(`${SCRIPT_URL}?user=${encodeURIComponent(username)}&islandId=${currentIslandId}`); const data = await resp.json();
                                                  if (data && data.length > 0) {data.forEach(item => {const el = document.getElementById(item.id);
                                                                                                      if (el) { el.style.left = item.leftPercent + '%'; el.style.top = item.topPercent + '%';}});}} 
                                             catch (e) {console.log("æ­¡è¿ä¾†åˆ°æ­¤å³¶");}}
        
        // ğŸ¤ŸğŸ» åŠŸèƒ½ FUNCTIONï¼šğŸ’¾ å„²å­˜ SAVE    
        async function saveData() {const btn = document.getElementById('save-button'); if (btn.disabled) return;
                                   const items = document.querySelectorAll('.draggable');
                                   const positions = Array.from(items).map(el => ({id: el.id, leftPercent: parseFloat(el.style.left), topPercent: parseFloat(el.style.top)}));
                                   try {await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ user: username, islandId: currentIslandId, positions: positions })});
                                        showToast("æˆåŠŸå„²å­˜", "success");} catch (e) {console.error("Save Error:", e); showToast("å„²å­˜å¤±æ•—", 'error');} 
                                   finally { btn.disabled = false; btn.style.opacity = "1";}}
        // ğŸ¤ŸğŸ» åŠŸèƒ½ FUNCTIONï¼šâœ… ç¢ºèª CONFIRM
        const confirmModal = document.getElementById('confirm-modal');
        function closeConfirm() {confirmModal.classList.add('hidden'); if (currentReturningEl && currentReturningEl.parentNode) {bindDraggable(currentReturningEl);currentReturningEl = null;}}
        function openConfirm(title, onConfirm) {document.getElementById('confirm-title').innerText = title; const btn = document.getElementById('confirm-button'); btn.onclick = () => {onConfirm(); confirmModal.classList.add('hidden'); currentReturningEl = null;}; confirmModal.classList.remove('hidden');}
        function handleSave() {openConfirm("å„²å­˜é€²åº¦", () => {saveData();});}
        function handleReload() {openConfirm("é‡æ–°è¼‰å…¥", () => {location.reload();});}
        function handlePreview() {openConfirm("åˆ‡æ›è‡³é è¦½æ¨¡å¼", () => {window.location.href = `islanddisplay.html?user=${encodeURIComponent(username)}`;});}
        function handleHome() {openConfirm("è¿”å›ä¸»é ", () => {window.location.href = '../../index.html';});}
        function handleNPC() {openConfirm("æ¢è¨ª NPC", () => {window.location.href = 'islanddisplay.html?user=Testing';});}
            // âŒ é—œé–‰å½ˆçª— CLOSE MODAL
            confirmModal.addEventListener('click', (e) => {if (e.target === confirmModal) {confirmModal.classList.add('hidden');}});

        // ğŸ¤ŸğŸ» åŠŸèƒ½ FUNCTIONï¼šğŸ é€šçŸ¥ TOAST
        let toastTimer; function showToast(message, type = 'success') {const toast = document.getElementById('toast'); const icon = document.getElementById('toast-icon'); const msg = document.getElementById('toast-msg');
                                                                       clearTimeout(toastTimer); msg.innerText = message; icon.innerText = type === 'success' ? 'âœ¨' : 'âš ï¸';        
                                                                       toast.classList.remove('opacity-0', '-translate-y-4', 'pointer-events-none');
                                                                       toast.classList.add('opacity-100', 'translate-y-0');
                                                                       toastTimer = setTimeout(() => {toast.classList.add('opacity-0', '-translate-y-4', 'pointer-events-none');
                                                                                                      toast.classList.remove('opacity-100', 'translate-y-0');}, 2500);}


        // ğŸ“² æ‰‹æ©Ÿæ—‹è½‰æç¤º ORIENTATION NOTI
        function handleOrientationChange() {const warning = document.getElementById('orientation-noti-landscape'); 
                                            const isPortrait = window.innerHeight > window.innerWidth; const isMobileOrTablet = window.innerWidth < 700;
                                            if (isPortrait && isMobileOrTablet) {warning.style.setProperty('display', 'flex', 'important');} else {warning.style.display = 'none';}}
        window.addEventListener('resize', handleOrientationChange);
        window.addEventListener('orientationchange', handleOrientationChange);
        handleOrientationChange();

        // ğŸ” ç¸®æ”¾æ¯”ä¾‹ SCALE
        function autoScaleGame() {const stage = document.getElementById('game-stage'); if (!stage) return;
                                  const windowWidth = window.innerWidth; const windowHeight = window.innerHeight; const targetWidth = 1280; const targetHeight = 720;
                                  const scaleX = windowWidth / targetWidth; const scaleY = windowHeight / targetHeight; const finalScale = Math.min(scaleX, scaleY);stage.style.transform = `scale(${finalScale})`;}
        window.addEventListener('resize', autoScaleGame);
        window.addEventListener('orientationchange', () => {setTimeout(autoScaleGame, 200);});
        window.addEventListener('load', async () => {autoScaleGame(); setTimeout(async () => {await initApp();}, 100);});
        document.getElementById('island-buttons-container').addEventListener('dragstart', function(event) { if (event.target.tagName.toLowerCase() === 'a' || event.target.tagName.toLowerCase() === 'img') {event.preventDefault();}}, false);
    </script>
</body>
</html>

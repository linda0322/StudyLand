<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æˆ‘çš„å³¶å¶¼</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/svg" href="https://raw.githubusercontent.com/linda0322/zung1man4/refs/heads/main/image/icon/island_favicon.svg">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/linda0322/zung1man4/refs/heads/main/image/icon/island_favicon_phone.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @font-face {
            font-family: 'Cubic11';
            src: url('https://cdn.jsdelivr.net/gh/ACh-K/Cubic-11@90bc0e197c4db0fc8c75fe30c2d82dea03da707e/fonts/ttf/Cubic_11.ttf') format('truetype');
            font-display: swap;
        }
        body {font-family: 'Noto Sans TC', sans-serif; background-color: #1a1a1a; overflow: hidden; height: 100vh; width: 100vw; display: flex; align-items: center; justify-content: center; -webkit-user-select: none; overscroll-behavior: none;
             cursor: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 24 24' fill='%23BAE6FF'><path d='M17.5 19c2.5 0 4.5-2 4.5-4.5 0-2.3-1.7-4.1-3.9-4.4-.5-3.4-3.4-6.1-7-6.1-3.1 0-5.7 2-6.7 4.8C2.1 9.4 0 11.4 0 14c0 3 2.5 5.5 5.5 5.5h12z'/></svg>") 16 16, auto;
        }
        a, button, [role="button"], .npc-hover-animation {
            cursor: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='36' height='36' viewBox='0 0 24 24' fill='white'><path d='M17.5 19c2.5 0 4.5-2 4.5-4.5 0-2.3-1.7-4.1-3.9-4.4-.5-3.4-3.4-6.1-7-6.1-3.1 0-5.7 2-6.7 4.8C2.1 9.4 0 11.4 0 14c0 3 2.5 5.5 5.5 5.5h12z'/></svg>") 16 16, pointer !important;
        }

        /* ç»ç’ƒå¤–æ¡† */
        .glass-panel {background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.3);}
        /* å­—é«” */
        .font-cubic { font-family: 'Cubic11', sans-serif; }
        .thin-border { -webkit-text-stroke: 0.5px currentColor; paint-order: stroke fill; }
        .thick-border { -webkit-text-stroke: 1px currentColor; paint-order: stroke fill; }

        /* åŠ è¼‰é®ç½©ï¼ˆé£›è¡Œä¸­ï¼‰LOADING */
        #loading-screen { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(15px); z-index: 6000; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s ease, visibility 0.5s ease; }
        #loading-screen.fade-out { opacity: 0; visibility: hidden; }
        
        /* 16:9 å¤–æ¡† FRAME */
        #game-stage { position: relative; width: 100vw; height: 56.25vw; max-height: 100vh; max-width: 177.78vh; background-color: #333; overflow: hidden; }
        /* å³¶å¶¼èƒŒæ™¯åœ– BACKGROUND IMAGE */
        #background-img { width: 100%; height: 100%; object-fit: fill; position: absolute; inset: 0; z-index: 1; pointer-events: none; user-select: none;}
        /* æ‹–æ›³ç‰©ä»¶ DRAGGABLE ITEMS */
        .draggable { position: absolute; z-index: 10; width: 12%; touch-action: none; cursor: move; 
                    user-select: none; -webkit-user-drag: -webkit-user-select: none; -ms-user-select: none; -moz-user-select: none; -webkit-touch-callout: none;}
        .draggable img { width: 100%; height: auto; pointer-events: none; }

        /* å€‰åº« WAREHOUSE */
        .tab-active { background: #64748b !important; color: white !important; }
        .inventory-item { transition: all 0.2s; cursor: pointer; }
        .inventory-item:hover { transform: scale(1.05); background: rgba(255,255,255,0.9); }

        /* æ‰‹æ©Ÿæ—‹è½‰æç¤º ORIENTATION */
        #orientation-warning {display: none; position: fixed; inset: 0; z-index: 99999; background-color: #1dc5fd; flex-direction: column; align-items: center; justify-content: center;}
        @media screen and (max-width: 700px) and (orientation: portrait) {#orientation-warning {display: flex !important;} #game-stage { display: none; }}
        @keyframes phone-rotate-right {0% { transform: rotate(90deg); } 30% { transform: rotate(0deg); } 70% { transform: rotate(0deg); } 100% { transform: rotate(90deg); }}
        .animate-phone-rotate {animation: phone-rotate-right 2s ease-in-out infinite;}

        /**--**/
        /* å³¶å¶¼é¸å–® MENU */
        #island-menu { transition: opacity 0.3s ease; }    
    
    </style>
</head>
<body>

    <!-- åŠ è¼‰é®ç½©ï¼ˆé£›è¡Œä¸­ï¼‰LOADING -->
    <div id="loading-screen">
        <div class="animate-bounce text-3xl mb-4">â˜ï¸</div>
        <div class="font-cubic text-xl text-white thick-border tracking-widest">é£›è¡Œä¸­</div>
    </div>

    <!-- æ‰‹æ©Ÿæ—‹è½‰æç¤º ORIENTATION -->
    <div id="orientation-warning">
        <button onclick="location.href='../index.html'" class="absolute top-5 left-6 z-[10000] glass-panel p-3 rounded-full text-slate-500 shadow-md hover:bg-white/20 active:scale-95 transition-all" title="è¿”å›">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
        </button>
        <div class="w-20 h-20 mb-6 animate-phone-rotate flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="20" x="5" y="2" rx="2" ry="2"/><path d="M12 18h.01"/></svg>
        </div>
        <h2 class="font-cubic text-xl text-white thick-border tracking-wider">è«‹æ—‹è½‰è¢å¹•ä»¥é€²å…¥å³¶å¶¼</h2>
    </div>

    <!-- å°è¦½åŠæŒ‰éˆ• BUTTONS -->
    <nav>
        <!-- å·¦é‚Šç¾¤çµ„ LEFT -->
        <div class="fixed top-4 left-4 z-[100] flex items-center gap-3">
            <!-- è¿”å›ä¸»é  MAIN PAGE -->
            <button onclick="location.href='../index.html'" class="glass-panel p-2 rounded-full text-slate-500 shadow-md hover:bg-white/20 hover:text-white active:scale-95 transition-all" title="è¿”å›">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-door-open-icon lucide-door-open"><path d="M11 20H2"/><path d="M11 4.562v16.157a1 1 0 0 0 1.242.97L19 20V5.562a2 2 0 0 0-1.515-1.94l-4-1A2 2 0 0 0 11 4.561z"/><path d="M11 4H8a2 2 0 0 0-2 2v14"/><path d="M14 12h.01"/><path d="M22 20h-3"/></svg>
            </button>
            <!-- å³¶å¶¼é¸å–®åŠåœ°é»é¡¯ç¤º ISLAND MENU & LOCATION -->
            <button onclick="toggleIslandMenu()" class="glass-panel group rounded-full text-slate-500 shadow-md flex items-center px-4 py-2 gap-3 hover:bg-white/20 active:scale-95 transition-all">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-map-pinned-icon lucide-map-pinned group-hover:text-white transition-colors""><path d="M18 8c0 3.613-3.869 7.429-5.393 8.795a1 1 0 0 1-1.214 0C9.87 15.429 6 11.613 6 8a6 6 0 0 1 12 0"/><circle cx="12" cy="8" r="2"/><path d="M8.714 14h-3.71a1 1 0 0 0-.948.683l-2.004 6A1 1 0 0 0 3 22h18a1 1 0 0 0 .948-1.316l-2-6a1 1 0 0 0-.949-.684h-3.712"/></svg> 
                <span id="island-title" class="text-[13px] text-slate-500 font-cubic thin-border text-center tracking-wider group-hover:text-white transition-colors"">å°‡æŠµé”...</span>
            </button>     
            <!-- å€‰åº«æŒ‰éˆ• WAREHOUSE BUTTON -->
            <button onclick="toggleWarehouse()" class="glass-panel p-2 rounded-full text-slate-500 shadow-md hover:bg-white/20 hover:text-white active:scale-95 transition-all" title="å€‰åº«">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-warehouse-icon lucide-warehouse"><path d="M18 21V10a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1v11"/><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V8a2 2 0 0 1 1.132-1.803l7.95-3.974a2 2 0 0 1 1.837 0l7.948 3.974A2 2 0 0 1 22 8z"/><path d="M6 13h12"/><path d="M6 17h12"/></svg>
            </button>
        </div>
        <!-- å³é‚Šç¾¤çµ„ RIGHT -->
        <div class="fixed top-4 right-4 z-[100] flex items-center gap-3">
            <!-- å„²å­˜é€²åº¦ SAVE -->
            <button id="save-btn" onclick="saveData()" class="glass-panel p-2 rounded-full text-sky-700 shadow-md hover:bg-white/20 hover:text-white active:scale-95 transition-all" title="å„²å­˜">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-save-icon lucide-save"><path d="M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"/><path d="M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7"/><path d="M7 3v4a1 1 0 0 0 1 1h7"/></svg>
            </button>
            <!-- é‡æ–°æ•´ç† RELOAD -->
            <button id="reload-btn" onclick="location.reload()" class="glass-panel p-2 rounded-full text-sky-700 shadow-md hover:bg-white/20 hover:text-white active:scale-95 transition-all" title="é‡æ–°æ•´ç†">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
            </button>  
        </div>
    </nav>

    <!-- å€‰åº«å½ˆçª— WAREHOUSE WINDOW -->
    <div id="warehouse-window" class="fixed inset-0 z-[3000] bg-black/30 backdrop-blur-md hidden flex items-center justify-center p-4">
        <div class="glass-panel w-full max-w-lg rounded-[30px] p-6 shadow-2xl relative">
            <button onclick="toggleWarehouse()" class="absolute top-5 right-6 text-slate-400 hover:text-slate-600 hover:scale-95 transition-all">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x-icon lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
            </button>
            <h2 class="font-cubic thick-border text-xl text-slate-600 mb-6 text-center tracking-widest">å€‰åº«</h2>
            <div id="warehouse-tabs" class="flex gap-2 mb-4 overflow-x-auto pb-2 no-scrollbar"></div>
            <div id="warehouse-items" class="grid grid-cols-3 sm:grid-cols-4 gap-4 max-h-[40vh] overflow-y-auto p-2 border-t border-slate-200 pt-4">
                <p class="col-span-full text-center py-10 text-slate-400 font-cubic">æ­£åœ¨å°‹æ‰¾é‘°åŒ™...</p>
            </div>
            <p class="text-[10px] text-slate-400 mt-4 text-center font-cubic">* é»æ“Šç‰©ä»¶å³å¯éƒ¨ç½²åˆ°å³¶å¶¼ä¸­å¿ƒ</p>
        </div>
    </div>
        
    <!-- å³¶å¶¼é¸å–® MENU -->
    <div id="island-menu" class="fixed inset-0 z-[2000] bg-black/30 backdrop-blur-md hidden flex items-center justify-center">
        <div class="glass-panel p-8 rounded-[40px] w-[80%] max-w-2xl relative shadow-2xl border-white/50">
            <button onclick="toggleIslandMenu()" class="absolute top-6 right-8 text-2xl text-slate-400 hover:text-slate-600 hover:scale-95 transition-all">
            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x-icon lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
            </button>
            <h2 class="font-cubic text-xl thick-border text-center mb-8 text-slate-600 tracking-widest">æƒ³å»å“ªè£¡ï¼Ÿ</h2>
            <div id="island-buttons-container" class="grid grid-cols-3 gap-6 w-full">
                <div class="col-span-3 w-full flex flex-col items-center justify-center py-12 gap-4">
                    <span class="text-5xl">ğŸ—ºï¸</span>
                    <p class="w-full col-span-full text-center tracking-widest thin-border text-slate-400 font-cubic py-8 flex justify-center items-center">æ­£åœ¨æ‰“é–‹åœ°åœ–</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 16:9 å¤–æ¡†åŠç‰©ä»¶ FRAME & ITEMS -->
    <div id="game-stage">
        <div id="background-layer"><img id="background-img" src="" alt="background"></div>
        <div id="items-layer"></div>
    </div>

    <!-- é€šçŸ¥ TOAST -->
    <div id="toast" class="fixed top-12 left-1/2 -translate-x-1/2 z-[9999] px-6 py-3 rounded-2xl glass-panel shadow-2xl transition-all duration-500 opacity-0 -translate-y-4 pointer-events-none flex items-center gap-3">
        <div id="toast-icon" class="text-xl"></div>
        <span id="toast-msg" class="font-cubic text-slate-600 thin-border tracking-wider"></span>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxPxLzM47qozl9CJxGjjf0wMdtPppx8Kt8R1caUnAQpCX-s3ol6lERYawriMQFv6p3a/exec'; 

        // æ²å‹•æ§åˆ¶ SCROLL
        let startY = 0;
        document.addEventListener('touchstart', (e) => { startY = e.touches[0].pageY; }, { passive: false });
        
        const username = localStorage.getItem('studyLandUser');
        const urlParams = new URLSearchParams(window.location.search);
        const currentIslandId = urlParams.get('id') || 'island_1';
        let assetLibrary = {};
        let userInventory = []; 

        // å³¶å¶¼èƒŒæ™¯åœ– BACKGROUND IMAGE
        const islandConfig = {
            'island_1': { name: 'è‰åœ°', bg: 'https://raw.githubusercontent.com/linda0322/StudyLand/refs/heads/main/image/island/background/first.webp', color: 'bg-lime-200', icon: 'ğŸŒ³' },
            'island_2': { name: 'æµ·æ´‹', bg: 'https://raw.githubusercontent.com/linda0322/StudyLand/refs/heads/main/image/island/background/second.webp', color: 'bg-sky-200', icon: 'ğŸŒŠ' },
            'island_3': { name: 'æ²™æ¼ ', bg: 'https://raw.githubusercontent.com/linda0322/StudyLand/refs/heads/main/image/island/background/third.webp', color: 'bg-amber-200', icon: 'ğŸœï¸' },
        };

        // è¼‰å…¥é›²ç«¯è³‡æ–™ CLOUD INFORMATION
        async function initApp() {
            // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
            if (!username) { window.location.href = '../index.html'; return; }
            // ç´€éŒ„é–‹å§‹æ™‚é–“ï¼ˆæ§åˆ¶ Loading é®ç½©é¡¯ç¤ºæ™‚é•·ï¼‰
            const startTime = Date.now();
            // è¨­å®šå³¶å¶¼
            const config = islandConfig[currentIslandId] || islandConfig['island_1'];
            document.getElementById('background-img').src = config.bg;
            document.getElementById('island-title').innerText = config.name;
            try {
                /* è¼‰å…¥åŸºç¤è³‡æ–™ */
                const [libResp, posResp] = await Promise.all([fetch(`${SCRIPT_URL}?action=getLibrary`),
                                                              fetch(`${SCRIPT_URL}?user=${encodeURIComponent(username)}&islandId=${currentIslandId}&action=getPositions`)]);
                assetLibrary = await libResp.json();
                const savedItems = await posResp.json();
                /* è¼‰å…¥å·²å„²å­˜çš„ç‰©ä»¶ */
                const itemsLayer = document.getElementById('items-layer'); itemsLayer.innerHTML = '';
                if (Array.isArray(savedItems)) { savedItems.forEach(item => {
                        /* ID æ ¼å¼ç‚ºã€Œitem_åç¨±_åºè™Ÿã€*/
                        const assetType = item.id.replace('item_', '').split('_')[0];
                        if (assetLibrary[assetType]) {
                            createDraggableElement(item.id, assetType, item.leftPercent, item.topPercent);}});
                }
                /* è¼‰å…¥é¸å–®èˆ‡å€‰åº«è³‡è¨Š */
                await loadIslandList(); await refreshInventory(); 
            } catch (err) { console.error("è¼‰å…¥å¤±æ•—:", err); showToast("é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯", "error");
                          } finally {
                /* éš±è—é®ç½© */
                const elapsedTime = Date.now() - startTime; const minimumWait = 1000; const remainingWait = Math.max(0, minimumWait - elapsedTime);
                setTimeout(() => { const loader = document.getElementById('loading-screen'); if (loader) { loader.classList.add('fade-out');
                setTimeout(() => loader.style.display = 'none', 500);}
                }, remainingWait);
            }
        }

        // è³‡ç”¢ ASSETS
            /* è¼‰å…¥ç‰©ä»¶ */
            function createDraggableElement(id, type, left = 50, top = 50) {
                const config = assetLibrary[type];
                const div = document.createElement('div');
                div.className = 'draggable';
                div.id = id;
                div.style.width = config.width || '12%';
                div.style.left = left + '%';
                div.style.top = top + '%';
                div.style.transform = 'translate(-50%, -50%)';
                div.style.zIndex = config.isBottom ? "1" : "10";
                if (config.isBottom) div.dataset.isBottom = "true";
                div.innerHTML = `<img src="${config.imgURL}">`;
                div.oncontextmenu = (e) => {e.preventDefault(); if(confirm("è¦æ”¶å›å€‰åº«å—ï¼Ÿ")) {div.remove(); showToast("å·²æ”¶å›å€‰åº«"); refreshInventory(); }};
                document.getElementById('items-layer').appendChild(div); bindDraggable(div); 
            }
            /* æ‹–æ›³ç‰©ä»¶ */
            function bindDraggable(el) {const stage = document.getElementById('game-stage'); el.onmousedown = el.ontouchstart = function(e) {
                const isTouch = e.type === 'touchstart';
                const clientX = isTouch ? e.touches[0].clientX : e.clientX;
                const clientY = isTouch ? e.touches[0].clientY : e.clientY;
                if (el.dataset.isBottom !== "true") {document.querySelectorAll('.draggable:not([data-is-bottom="true"])').forEach(d => d.style.zIndex = "10"); el.style.zIndex = "100";}
                const rect = el.getBoundingClientRect();
                const stageRect = stage.getBoundingClientRect();
                const shiftX = clientX - rect.left;
                const shiftY = clientY - rect.top;
                function moveAt(clientX, clientY) {
                    let newL = clientX - stageRect.left - shiftX + (rect.width / 2);
                    let newT = clientY - stageRect.top - shiftY + (rect.height / 2);
                    newL = Math.max(0, Math.min(newL, stageRect.width));
                    newT = Math.max(0, Math.min(newT, stageRect.height));
                    el.style.left = (newL / stageRect.width * 100) + '%';
                    el.style.top = (newT / stageRect.height * 100) + '%';
                }
                function onMouseMove(e) {
                    const moveX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
                    const moveY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
                    moveAt(moveX, moveY);
                }
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('touchmove', onMouseMove, {passive: false});
                el.onmouseup = el.ontouchend = function() {
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('touchmove', onMouseMove);
                    el.onmouseup = el.ontouchend = null;
                };
            };}

        // å€‰åº« WAREHOUSE
        function toggleWarehouse() {const win = document.getElementById('warehouse-window');
            if (win.classList.contains('hidden')) {win.classList.remove('hidden'); refreshInventory();
            } else {win.classList.add('hidden');}
        }
            /* åº«å­˜ INVENTORY */
            async function refreshInventory() {
                const container = document.getElementById('warehouse-items');
                try {
                    const resp = await fetch(`${SCRIPT_URL}?user=${encodeURIComponent(username)}&action=getInventory`);
                    userInventory = await resp.json();
                    const categories = ['å…¨éƒ¨', ...new Set(userInventory.map(i => i.category))]; /** åˆ†é¡ TAB CATEGORY **/
                    const tabContainer = document.getElementById('warehouse-tabs');
                    tabContainer.innerHTML = categories.map(cat => `
                        <button onclick="filterWarehouse('${cat}')" class="tab-btn whitespace-nowrap px-4 py-1 rounded-full bg-slate-100 text-xs font-cubic text-slate-500 transition-all">
                            ${cat}
                        </button>
                    `).join('');
                    renderInventoryItems('å…¨éƒ¨');
                } catch (e) {container.innerHTML = "è¼‰å…¥å¤±æ•—";}
            }
        
            function renderInventoryItems(filter) {
                const container = document.getElementById('warehouse-items');
                const items = filter === 'å…¨éƒ¨' ? userInventory : userInventory.filter(i => i.category === filter);
                if (items.length === 0) {container.innerHTML = `<p class="col-span-full text-center py-10 text-slate-400 font-cubic">ä¸€ç„¡æ‰€æœ‰</p>`; return;}
                container.innerHTML = items.map(item => `
                    <div onclick="deployFromWarehouse('${item.assetType}')" class="inventory-item glass-panel p-2 rounded-xl flex flex-col items-center justify-center gap-2">
                        <img src="${item.imgURL}" class="w-12 h-12 object-contain">
                        <span class="text-[10px] font-cubic text-slate-400">å‰©é¤˜: ${item.available}</span>
                    </div>
                `).join('');
            }

            function filterWarehouse(cat) {document.querySelectorAll('.tab-btn').forEach(btn => {btn.classList.toggle('tab-active', btn.innerText.trim() === cat);}); 
                                           renderInventoryItems(cat);}
        
            function deployFromWarehouse(type) {const existing = document.querySelectorAll(`[id^="item_${type}_"]`);
                let maxNum = 0; existing.forEach(el => {const num = parseInt(el.id.split('_').pop()); if (num > maxNum) maxNum = num;});
                const newId = `item_${type}_${maxNum + 1}`; createDraggableElement(newId, type, 50, 50); toggleWarehouse(); showToast("å·²æ”¾ç½®");
                const invIdx = userInventory.findIndex(i => i.assetType === type);
                if (invIdx > -1) {userInventory[invIdx].available--; if (userInventory[invIdx].available <= 0) userInventory.splice(invIdx, 1);}
            }

        // å³¶å¶¼é¸å–® MENU
        function toggleIslandMenu() { document.getElementById('island-menu').classList.toggle('hidden'); }
        
        async function loadIslandList() {
            try {const response = await fetch(`${SCRIPT_URL}?user=${encodeURIComponent(username)}&action=getIslands`);
                 const allowedIslands = await response.json();
                 const container = document.getElementById('island-buttons-container'); container.innerHTML = ''; 
                 if (allowedIslands.length === 0) {container.innerHTML = `
                 <div class="col-span-3 w-full flex flex-col items-center justify-center py-12 gap-4"><span class="text-5xl">ğŸï¸</span>
                 <p class="text-slate-400 font-cubic text-center tracking-widest thin-border">ç›®å‰ç„¡å³¶å¯æ­¸</p>
                 </div>`; return;}
                 allowedIslands.forEach(id => {const cfg = islandConfig[id] || { name: 'æœªçŸ¥å³¶å¶¼', color: 'bg-slate-100', icon: 'ğŸï¸' };
                 const btnHtml = `
                 <a href="island.html?id=${id}" class="group bg-slate-50 p-4 rounded-[25px] hover:bg-white hover:shadow-xl transition-all text-center">
                 <div class="${cfg.color} h-20 rounded-[20px] mb-2 flex items-center justify-center text-3xl">${cfg.icon}</div>
                 <h3 class="font-cubic text-lg text-slate-500 thin-border">${cfg.name}</h3>
                 </a>`;
                 container.innerHTML += btnHtml;});
            } catch (e) {console.error("è¼‰å…¥å¤±æ•—", e);}
        }

        async function loadIslandData() {try {const resp = await fetch(`${SCRIPT_URL}?user=${encodeURIComponent(username)}&islandId=${currentIslandId}`); const data = await resp.json();
                                              if (data && data.length > 0) { data.forEach(item => {const el = document.getElementById(item.id);
                                                                                                   if (el) { el.style.left = item.leftPercent + '%'; el.style.top = item.topPercent + '%';}});}
                                             } catch (e) { console.log("æ­¡è¿ä¾†åˆ°æ­¤å³¶ï¼"); }
        }
        
        // å„²å­˜åŠŸèƒ½ SAVE
        async function saveData() {
            const btn = document.getElementById('save-btn'); if (btn.disabled) return;
            const items = document.querySelectorAll('.draggable');
            const positions = Array.from(items).map(el => ({id: el.id, leftPercent: parseFloat(el.style.left), topPercent: parseFloat(el.style.top)}));
            try { await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ user: username, islandId: currentIslandId, positions: positions })});
                  showToast("æˆåŠŸå„²å­˜", "success");} catch (e) {console.error("Save Error:", e); showToast("å„²å­˜å¤±æ•—", 'error');
                } finally { btn.disabled = false; btn.style.opacity = "1";}
        }

        // é€šçŸ¥ TOAST
        let toastTimer;
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toast-icon');
            const msg = document.getElementById('toast-msg');
            clearTimeout(toastTimer);
            msg.innerText = message;
            icon.innerText = type === 'success' ? 'âœ¨' : 'âš ï¸';        
            toast.classList.remove('opacity-0', '-translate-y-4', 'pointer-events-none');
            toast.classList.add('opacity-100', 'translate-y-0');
            toastTimer = setTimeout(() => {
                toast.classList.add('opacity-0', '-translate-y-4', 'pointer-events-none');
                toast.classList.remove('opacity-100', 'translate-y-0');
            }, 2500);
        }

        // æ‰‹æ©Ÿæ—‹è½‰æç¤º ORIENTATION
        function handleOrientationChange() {
            const warning = document.getElementById('orientation-warning');
            const isPortrait = window.innerHeight > window.innerWidth;
            const isMobileOrTablet = window.innerWidth < 700;
            if (isPortrait && isMobileOrTablet) {warning.style.setProperty('display', 'flex', 'important');} else {warning.style.display = 'none';}
        }
        window.addEventListener('resize', handleOrientationChange);
        window.addEventListener('orientationchange', handleOrientationChange);
        handleOrientationChange();

        window.onload = initApp;

    </script>
</body>
</html>
